# Express Bets - Frontend и Оптимизация (Phase 2-3)

## Дата: 2024-11-29

## Обзор изменений

Реализация Phase 2 (Frontend) и Phase 3 (Оптимизация) функционала экспресс-прогнозов.

### Phase 2: Frontend

#### Новые файлы

1. **`frontend/src/api/expressApi.ts`**
   - API клиент для работы с экспрессами
   - Реализует кэширование с SWR (Stale-While-Revalidate) паттерном
   - Дедупликация запросов (inflight requests)
   - Функции: `fetchMyExpresses`, `fetchWeekCount`, `fetchExpressConfig`, `createExpress`, `fetchExpressById`
   - Вспомогательные функции: `translateExpressError`, `getMultiplierForItemCount`, `formatMultiplier`

2. **`frontend/src/components/ExpressBuilder.tsx`**
   - Компонент для создания экспресс-прогнозов
   - Интерактивный выбор событий из разных матчей
   - Показ расчёта очков и множителя в реальном времени
   - Проверка лимитов (2 экспресса за 6 дней, 2-4 события)
   - Адаптивный дизайн

3. **`frontend/src/components/ExpressBuilder.css`**
   - Стили для ExpressBuilder
   - Градиенты и анимации в золотых тонах (для отличия от обычных прогнозов)

4. **`frontend/src/components/ExpressList.tsx`**
   - Компонент для отображения списка экспрессов пользователя
   - Раскрывающиеся карточки с детальной информацией
   - Прогресс-индикаторы (точки) для каждого события
   - Анимации выигрыша/проигрыша

5. **`frontend/src/components/ExpressList.css`**
   - Стили для ExpressList
   - Анимации: пульсация при выигрыше, тряска при проигрыше
   - Цветовая кодировка статусов

#### Изменённые файлы

6. **`frontend/src/pages/PredictionsPage.tsx`**
   - Добавлен импорт `ExpressBuilder` и `ExpressList`
   - `ExpressBuilder` интегрирован в таб "Ближайшие" (отображается при наличии матчей)
   - `ExpressList` интегрирован в таб "Мои прогнозы" (выше одиночных прогнозов)

7. **`frontend/src/styles/predictions.css`**
   - Добавлены стили для контейнера "Мои прогнозы":
     - `.my-predictions-container`
     - `.my-predictions-section-title`

### Phase 3: Оптимизация (Redis кэширование)

#### Изменённые файлы

1. **`backend/src/services/predictionConstants.ts`**
   - Добавлены константы для кэширования счётчика:
     - `EXPRESS_WEEK_COUNT_CACHE_KEY`
     - `EXPRESS_WEEK_COUNT_TTL_SECONDS` (60 секунд)
     - `EXPRESS_WEEK_COUNT_STALE_SECONDS` (180 секунд)

2. **`backend/src/routes/expressRoutes.ts`**
   - Добавлен импорт новых констант кэширования
   - Endpoint `/week-count` теперь использует Redis кэш с SWR
   - При создании экспресса инвалидируются оба кэша: `EXPRESS_USER_CACHE_KEY` и `EXPRESS_WEEK_COUNT_CACHE_KEY`
   - Добавлены заголовки ETag и Cache-Control для `week-count`

## TTL стратегия

### Frontend (localStorage)

| Ресурс | Fresh TTL | Stale TTL | Описание |
|--------|-----------|-----------|----------|
| My Expresses | 5 мин | 15 мин | Список экспрессов пользователя |
| Week Count | 1 мин | 3 мин | Счётчик для проверки лимита |
| Config | 1 час | 24 часа | Конфигурация (множители, лимиты) |

### Backend (Redis)

| Ресурс | Fresh TTL | Stale TTL | Описание |
|--------|-----------|-----------|----------|
| express:user:{id} | 5 мин | 15 мин | Список экспрессов пользователя |
| express:weekCount:{id} | 1 мин | 3 мин | Счётчик экспрессов за неделю |

## Инвалидация кэша

1. **При создании экспресса** (POST /api/predictions/express):
   - `express:user:{userId}` - обновить список
   - `express:weekCount:{userId}` - обновить счётчик

2. **При расчёте экспресса** (из predictionSettlement):
   - `express:user:{userId}` - обновить статус и очки

## UI компоненты

### ExpressBuilder

```
┌────────────────────────────────────────────┐
│ ⚡ Собрать экспресс                    [2] │
├────────────────────────────────────────────┤
│ Экспресс-прогноз        Осталось: 2/2     │
│ Объедините 2-4 события из разных матчей   │
│                                            │
│ Выбрано: 2/4                    [Очистить] │
│ ┌────────────────────────────────────────┐ │
│ │ КРЕ — СТА    22.11 18:00               │ │
│ │ Исход: П1                      +10  ✕  │ │
│ └────────────────────────────────────────┘ │
│ ┌────────────────────────────────────────┐ │
│ │ ДОЖ — ПОЛ    23.11 15:00               │ │
│ │ Тотал: ТБ 2.5                  +12  ✕  │ │
│ └────────────────────────────────────────┘ │
│                                            │
│ ┌────────────────────────────────────────┐ │
│ │ Базовые очки:                      22  │ │
│ │ Множитель (2 события):           ×1.2  │ │
│ │ Итого при выигрыше:               +26  │ │
│ └────────────────────────────────────────┘ │
│                                            │
│ [      СОЗДАТЬ ЭКСПРЕСС (×1.2)          ] │
└────────────────────────────────────────────┘
```

### ExpressList

```
┌────────────────────────────────────────────┐
│ ⚡ Экспрессы                               │
│                                            │
│ ┌────────────────────────────────────────┐ │
│ │ 3 событий  ВЫИГРЫШ    ×1.5    +33      │ │
│ │ ● ● ●                              ▼   │ │
│ ├────────────────────────────────────────┤ │
│ │ ✓ 2  ✕ 0  ⏳ 1                         │ │
│ │                                        │ │
│ │ ✓ КРЕ — СТА  22.11 18:00  П1    +10   │ │
│ │ ✓ ДОЖ — ПОЛ  23.11 15:00  ТБ    +12   │ │
│ │ ⏳ ФЛА — ДИН 24.11 17:00  Нет   +8    │ │
│ │                                        │ │
│ │                  Создан: 21.11 12:30   │ │
│ └────────────────────────────────────────┘ │
└────────────────────────────────────────────┘
```

## Анимации

1. **Выигрыш экспресса**:
   - Пульсирующий эффект карточки (3 раза)
   - Оверлей с надписью "🎉 ВЫИГРЫШ! 🎉" и количеством очков
   - Автоматически исчезает через 4 секунды

2. **Проигрыш экспресса**:
   - Лёгкая тряска карточки

3. **Прогресс-точки**:
   - Золотой цвет для PENDING
   - Зелёный для WON
   - Красный для LOST

## Тестирование

Все сборки и линтеры проходят:
- ✅ `npm run build` (backend)
- ✅ `npm run build` (frontend)
- ✅ `npm run build` (admin)
- ✅ `npm run lint` (backend)
- ✅ `npm run lint` (frontend)
- ✅ `npm run lint` (admin)

## Связанные файлы

- Phase 1 документация: `audit/changes/20251129-express-bets-phase1.md`
- Концепция и анализ: `docs/prog.md`
