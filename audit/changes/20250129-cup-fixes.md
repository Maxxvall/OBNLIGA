# Исправления проблем с кубками и кэшированием

**Дата**: 2025-01-29

## Проблемы

1. **Матчи застревают в календаре** - завершённые матчи продолжают отображаться
2. **Таблица не обновляется** - данные не обновляются после завершения матчей
3. **Чемпион объявляется раньше времени** - после завершения групп кубка показывается чемпион
4. **Плей-офф пары формируются неправильно** - команды из одной группы встречаются в ЧФ
5. **Полуфиналы не создаются** - после завершения четвертьфиналов
6. **Internal Server Error в админке** - при завершении матча

## Исправления

### 1. TTL кэша (matchWindowHelper.ts)

Уменьшен TTL для кэша вне матчевого окна с **7 дней** до **1 часа**:

```typescript
// Было
leagueTable.outside: { ttlSeconds: 604_800 } // 7 дней!
leagueSchedule.outside: { ttlSeconds: 604_800 }
friendliesSchedule.outside: { ttlSeconds: 604_800 }

// Стало
leagueTable.outside: { ttlSeconds: 3_600 } // 1 час
leagueSchedule.outside: { ttlSeconds: 3_600 }
friendliesSchedule.outside: { ttlSeconds: 3_600 }
```

### 2. Определение чемпиона кубка (LeagueRoundsView.tsx)

Добавлена проверка типа соревнования — для кубков чемпион определяется **только по плей-офф серии**:

```tsx
const isCup = season.competition?.type === 'CUP'
const allowTableFallback = !isCup && !playoffState.hasSeries && (...)
```

### 3. Кросс-групповой паринг для кубков (seasonAutomation.ts)

Для кубков с 2 группами по 4-5 команд теперь используется `generateQuarterFinalPairs2Groups`:

- QF1: A1 vs B4
- QF2: B1 vs A4  
- QF3: A2 vs B3
- QF4: B2 vs A3

Это гарантирует, что команды из одной группы **не встретятся** в первом раунде плей-офф.

### 4. Обработка ошибок при завершении матча (adminRoutes.ts)

Добавлен try-catch для `handleMatchFinalization`:

```typescript
if (body.status === MatchStatus.FINISHED && existing.status !== MatchStatus.FINISHED) {
  try {
    await handleMatchFinalization(matchId, request.server.log, { publishTopic })
  } catch (err) {
    request.server.log.error(
      { err, matchId: matchId.toString() },
      'failed to finalize match after status update'
    )
    // Матч уже обновлён в БД, не возвращаем ошибку пользователю
  }
}
```

### 5. Валидация конфигурации кубка (adminRoutes.ts)

Добавлена валидация допустимых комбинаций групп для кубков:

- 2 группы × 4 команды (8 команд)
- 2 группы × 5 команд (10 команд)
- 3 группы × 3 команды (9 команд)
- 3 группы × 4 команды (12 команд)
- 4 группы × 3 команды (12 команд)

При попытке создать кубок с другой конфигурацией возвращается ошибка `invalid_cup_config`.

## Файлы изменены

- `backend/src/cache/matchWindowHelper.ts` - TTL кэша
- `backend/src/services/seasonAutomation.ts` - кросс-групповой паринг
- `backend/src/routes/adminRoutes.ts` - валидация и обработка ошибок
- `frontend/src/components/league/LeagueRoundsView.tsx` - определение чемпиона

## Тестирование

1. Создать кубок с 2 группами по 5 команд
2. Завершить все групповые матчи
3. Проверить, что чемпион НЕ показывается
4. Создать плей-офф
5. Проверить, что пары A1-B4, B1-A4, A2-B3, B2-A3
6. Завершить четвертьфиналы
7. Проверить создание полуфиналов Gold и Silver
