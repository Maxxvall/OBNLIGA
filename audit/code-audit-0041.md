# audit/code-audit-0041

**Дата:** 2025-10-15  
**Задача:** Перевести публичное приложение на адаптивный HTTP-polling вместо WebSocket и обновить кэш-инструкции  
**Исполнитель:** GitHub Copilot

## 1. Поисковые запросы
- "wsClient"
- "ensureRealtime"

## 2. Просканированные пути
- frontend/src/
- backend/src/realtime/
- docs/

## 3. Найденные артефакты
- `frontend/src/wsClient.ts` — реализация публичного WS-клиента и авто-подписок вкладок
- `frontend/src/store/appStore.ts` — логика EnsureRealtime и клубных подписок через WS
- `frontend/src/components/NewsSection.tsx` — обновление новостей через WS-патчи
- `frontend/src/Profile.tsx` — реальное время профиля, выдача токена в WS
- `backend/src/realtime/index.ts` — серверный хаб, допускающий публичные подключения без токена
- `docs/cache.md` и `docs/state.md` — описывают текущий подход с WebSocket для публичных данных

## 4. Решение
Адаптировать существующие модули под новую стратегию: публичное приложение переходит на ETag-проверки и адаптивный polling, WebSocket остаётся только для авторизованных административных панелей. Требуется переписать клиентские эффекты (новости, лига, профиль) на интервальные запросы, обновить store для работы без realtime-патчей, ужесточить серверный хаб (обязательная авторизация) и синхронизировать документацию.

## 5. План реализации
- [x] Обновить публичный frontend: убрать зависимости от `wsClient`, внедрить polling в App, NewsSection, Profile и store
- [x] Перенастроить `appStore` на интервальные обновления лиги и клубов (адаптивные интервалы + cleanup)
- [x] Ужесточить `backend/src/realtime/index.ts`, запретив неавторизованные WebSocket-подключения и публичные топики
- [x] Обновить документацию (`docs/cache.md`, `docs/state.md`, при необходимости `docs/project.md`), зафиксировать подход
- [x] Зафиксировать изменения в `audit/changes/0038-*.md`
- [x] Проверить сборки `frontend` и `backend` (`npm run build`)

## 6. Метрическое влияние
⚪ — Переезд на polling снижает риск перегрузки WebSocket-хаба и соответствует ограничениям Render; нагрузка распределяется через ETag/TTL.
