// Структура БД приведена к схеме из docs/BD.md
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Club {
  id        Int     @id @default(autoincrement()) @map("club_id")
  name      String
  shortName String  @map("short_name")
  logoUrl   String? @map("logo_url")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  seasons           SeasonParticipant[]
  rosters           SeasonRoster[]
  homeSeries        MatchSeries[]           @relation("home_club")
  awaySeries        MatchSeries[]           @relation("away_club")
  wonSeries         MatchSeries[]           @relation("winner_club")
  matchesHome       Match[]                 @relation("match_home")
  matchesAway       Match[]                 @relation("match_away")
  clubPlayers       ClubPlayer[]
  playerStats       PlayerSeasonStats[]
  clubSeasonStats   ClubSeasonStats[]
  careerStats       PlayerClubCareerStats[]
  disqualifications Disqualification[]
  lineups           MatchLineup[]
  eventTeams        MatchEvent[]
  matchStatistics   MatchStatistic[]
  groupSlots        SeasonGroupSlot[]

  @@map("club")
}

model Person {
  id        Int     @id @default(autoincrement()) @map("person_id")
  firstName String  @map("first_name")
  lastName  String  @map("last_name")
  isPlayer  Boolean @default(true) @map("is_player")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  rosters           SeasonRoster[]
  lineups           MatchLineup[]
  events            MatchEvent[]            @relation("event_player")
  relatedEvents     MatchEvent[]            @relation("event_related")
  seasonStats       PlayerSeasonStats[]
  careerStats       PlayerClubCareerStats[]
  disqualifications Disqualification[]
  refereedMatches   Match[]                 @relation("match_referee")
  clubAffiliations  ClubPlayer[]
  linkedAppUsers    AppUser[]               @relation("AppUserLeaguePlayer")

  @@map("person")
}

model Competition {
  id           Int             @id @default(autoincrement()) @map("competition_id")
  name         String
  type         CompetitionType
  seriesFormat SeriesFormat    @map("series_format")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  seasons Season[]

  @@map("competition")
}

enum CompetitionType {
  LEAGUE
  CUP
}

enum SeriesFormat {
  SINGLE_MATCH
  TWO_LEGGED
  BEST_OF_N
  DOUBLE_ROUND_PLAYOFF
  PLAYOFF_BRACKET
  GROUP_SINGLE_ROUND_PLAYOFF
}

model Season {
  id            Int           @id @default(autoincrement()) @map("season_id")
  competitionId Int           @map("competition_id")
  name          String
  startDate     DateTime      @map("start_date")
  endDate       DateTime      @map("end_date")
  city          String?       @map("city")
  seriesFormat  SeriesFormat? @map("series_format")
  isActive      Boolean       @default(false) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  competition  Competition         @relation(fields: [competitionId], references: [id], onDelete: Restrict)
  participants SeasonParticipant[]
  rosters      SeasonRoster[]
  series       MatchSeries[]
  matches      Match[]
  playerStats  PlayerSeasonStats[]
  clubStats    ClubSeasonStats[]
  rounds       SeasonRound[]
  groups       SeasonGroup[]

  @@map("season")
}

model SeasonParticipant {
  seasonId Int @map("season_id")
  clubId   Int @map("club_id")

  season Season @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  club   Club   @relation(fields: [clubId], references: [id], onDelete: Restrict)

  @@id([seasonId, clubId])
  @@map("season_participant")
}

model SeasonRoster {
  seasonId         Int      @map("season_id")
  clubId           Int      @map("club_id")
  personId         Int      @map("person_id")
  shirtNumber      Int      @map("shirt_number")
  registrationDate DateTime @map("registration_date")

  season Season @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  club   Club   @relation(fields: [clubId], references: [id], onDelete: Cascade)
  person Person @relation(fields: [personId], references: [id], onDelete: Restrict)

  @@id([seasonId, clubId, personId])
  @@unique([seasonId, clubId, shirtNumber], name: "unique_shirt_per_season_club")
  @@map("season_roster")
}

model ClubPlayer {
  clubId             Int  @map("club_id")
  personId           Int  @map("person_id")
  defaultShirtNumber Int? @map("default_shirt_number")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  club   Club   @relation(fields: [clubId], references: [id], onDelete: Cascade)
  person Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@id([clubId, personId])
  @@map("club_player")
}

model Stadium {
  id   Int    @id @default(autoincrement()) @map("stadium_id")
  name String
  city String

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  matches Match[]

  @@map("stadium")
}

model SeasonRound {
  id          Int       @id @default(autoincrement()) @map("round_id")
  seasonId    Int       @map("season_id")
  roundType   RoundType @map("round_type")
  roundNumber Int?      @map("round_number")
  label       String    @map("label")
  groupId     Int?      @map("group_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  season  Season       @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  matches Match[]
  group   SeasonGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  @@unique([seasonId, label], name: "unique_round_label_per_season")
  @@map("season_round")
}

enum RoundType {
  REGULAR
  PLAYOFF
}

model MatchSeries {
  id           BigInt       @id @default(autoincrement()) @map("series_id")
  seasonId     Int          @map("season_id")
  stageName    String       @map("stage_name")
  homeClubId   Int          @map("home_club_id")
  awayClubId   Int          @map("away_club_id")
  seriesStatus SeriesStatus @map("series_status")
  winnerClubId Int?         @map("winner_club_id")
  homeSeed     Int?         @map("home_seed")
  awaySeed     Int?         @map("away_seed")
  bracketSlot  Int?         @map("bracket_slot")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  season     Season  @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  homeClub   Club    @relation("home_club", fields: [homeClubId], references: [id], onDelete: Restrict)
  awayClub   Club    @relation("away_club", fields: [awayClubId], references: [id], onDelete: Restrict)
  winnerClub Club?   @relation("winner_club", fields: [winnerClubId], references: [id], onDelete: SetNull)
  matches    Match[]

  @@map("match_series")
}

enum SeriesStatus {
  IN_PROGRESS
  FINISHED
}

model Match {
  id                 BigInt      @id @default(autoincrement()) @map("match_id")
  seasonId           Int?        @map("season_id")
  seriesId           BigInt?     @map("series_id")
  seriesMatchNumber  Int?        @map("series_match_number")
  matchDateTime      DateTime    @map("match_date_time")
  homeTeamId         Int         @map("home_team_id")
  awayTeamId         Int         @map("away_team_id")
  homeScore          Int         @default(0) @map("home_score")
  awayScore          Int         @default(0) @map("away_score")
  status             MatchStatus
  stadiumId          Int?        @map("stadium_id")
  refereeId          Int?        @map("referee_id")
  roundId            Int?        @map("round_id")
  groupId            Int?        @map("group_id")
  isArchived         Boolean     @default(false) @map("is_archived")
  hasPenaltyShootout Boolean     @default(false) @map("has_penalty_shootout")
  penaltyHomeScore   Int         @default(0) @map("penalty_home_score")
  penaltyAwayScore   Int         @default(0) @map("penalty_away_score")
  broadcastUrl       String?     @map("broadcast_url")
  eventName          String?     @map("event_name")
  isFriendly         Boolean     @default(false) @map("is_friendly")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  season              Season?              @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  series              MatchSeries?         @relation(fields: [seriesId], references: [id], onDelete: SetNull)
  homeClub            Club                 @relation("match_home", fields: [homeTeamId], references: [id], onDelete: Restrict)
  awayClub            Club                 @relation("match_away", fields: [awayTeamId], references: [id], onDelete: Restrict)
  stadium             Stadium?             @relation(fields: [stadiumId], references: [id], onDelete: SetNull)
  referee             Person?              @relation("match_referee", fields: [refereeId], references: [id], onDelete: SetNull)
  lineups             MatchLineup[]
  events              MatchEvent[]
  predictions         Prediction[]
  predictionTemplates PredictionTemplate[]
  round               SeasonRound?         @relation(fields: [roundId], references: [id], onDelete: SetNull)
  group               SeasonGroup?         @relation(fields: [groupId], references: [id], onDelete: SetNull)
  statistics          MatchStatistic[]

  @@unique([seriesId, seriesMatchNumber], map: "unique_series_match_number")
  @@map("match")
}

model SeasonGroup {
  id           Int    @id @default(autoincrement()) @map("season_group_id")
  seasonId     Int    @map("season_id")
  groupIndex   Int    @map("group_index")
  label        String
  qualifyCount Int    @map("qualify_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  season  Season            @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  slots   SeasonGroupSlot[]
  rounds  SeasonRound[]
  matches Match[]

  @@unique([seasonId, groupIndex], name: "unique_group_index_per_season")
  @@map("season_group")
}

model SeasonGroupSlot {
  id       Int  @id @default(autoincrement()) @map("season_group_slot_id")
  groupId  Int  @map("group_id")
  position Int  @map("position")
  clubId   Int? @map("club_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  group SeasonGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  club  Club?       @relation(fields: [clubId], references: [id], onDelete: SetNull)

  @@unique([groupId, position], name: "unique_slot_per_group")
  @@map("season_group_slot")
}

enum MatchStatus {
  SCHEDULED
  LIVE
  FINISHED
  POSTPONED
}

model MatchLineup {
  matchId  BigInt     @map("match_id")
  personId Int        @map("person_id")
  clubId   Int        @map("club_id")
  role     LineupRole
  position String?

  match  Match  @relation(fields: [matchId], references: [id], onDelete: Cascade)
  person Person @relation(fields: [personId], references: [id], onDelete: Restrict)
  club   Club   @relation(fields: [clubId], references: [id], onDelete: Restrict)

  @@id([matchId, personId])
  @@map("match_lineup")
}

enum LineupRole {
  STARTER
  SUBSTITUTE
}

model MatchEvent {
  id              BigInt         @id @default(autoincrement()) @map("event_id")
  matchId         BigInt         @map("match_id")
  teamId          Int            @map("team_id")
  minute          Int
  eventType       MatchEventType @map("event_type")
  playerId        Int            @map("player_id")
  relatedPlayerId Int?           @map("related_player_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  match         Match   @relation(fields: [matchId], references: [id], onDelete: Cascade)
  team          Club    @relation(fields: [teamId], references: [id], onDelete: Restrict)
  player        Person  @relation("event_player", fields: [playerId], references: [id], onDelete: Restrict)
  relatedPerson Person? @relation("event_related", fields: [relatedPlayerId], references: [id], onDelete: SetNull)

  @@map("match_event")
}

model MatchStatistic {
  matchId       BigInt   @map("match_id")
  clubId        Int      @map("club_id")
  totalShots    Int      @default(0) @map("total_shots")
  shotsOnTarget Int      @default(0) @map("shots_on_target")
  corners       Int      @default(0)
  yellowCards   Int      @default(0) @map("yellow_cards")
  redCards      Int      @default(0) @map("red_cards")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  match Match @relation(fields: [matchId], references: [id], onDelete: Cascade)
  club  Club  @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@id([matchId, clubId])
  @@map("match_statistic")
}

enum MatchEventType {
  GOAL
  PENALTY_GOAL
  OWN_GOAL
  PENALTY_MISSED
  YELLOW_CARD
  SECOND_YELLOW_CARD
  RED_CARD
  SUB_IN
  SUB_OUT
}

model PlayerSeasonStats {
  seasonId      Int @map("season_id")
  personId      Int @map("person_id")
  clubId        Int @map("club_id")
  goals         Int @default(0)
  penaltyGoals  Int @default(0) @map("penalty_goals")
  assists       Int @default(0)
  yellowCards   Int @default(0) @map("yellow_cards")
  redCards      Int @default(0) @map("red_cards")
  matchesPlayed Int @default(0) @map("matches_played")

  updatedAt DateTime @default(now()) @map("updated_at")

  season Season @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  person Person @relation(fields: [personId], references: [id], onDelete: Cascade)
  club   Club   @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@id([seasonId, personId])
  @@map("player_season_stats")
}

model PlayerClubCareerStats {
  personId     Int @map("person_id")
  clubId       Int @map("club_id")
  totalGoals   Int @default(0) @map("total_goals")
  penaltyGoals Int @default(0) @map("penalty_goals")
  totalMatches Int @default(0) @map("total_matches")
  totalAssists Int @default(0) @map("total_assists")
  yellowCards  Int @default(0) @map("yellow_cards")
  redCards     Int @default(0) @map("red_cards")

  person Person @relation(fields: [personId], references: [id], onDelete: Cascade)
  club   Club   @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@id([personId, clubId])
  @@map("player_club_career_stats")
}

model ClubSeasonStats {
  seasonId     Int @map("season_id")
  clubId       Int @map("club_id")
  points       Int @default(0)
  wins         Int @default(0)
  losses       Int @default(0)
  goalsFor     Int @default(0) @map("goals_for")
  goalsAgainst Int @default(0) @map("goals_against")

  updatedAt DateTime @default(now()) @map("updated_at")

  season Season @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  club   Club   @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@id([seasonId, clubId])
  @@map("club_season_stats")
}

model AppUser {
  id                      Int                @id @default(autoincrement()) @map("user_id")
  telegramId              BigInt             @unique @map("telegram_id")
  username                String?            @map("username")
  firstName               String?            @map("first_name")
  photoUrl                String?            @map("photo_url")
  registrationDate        DateTime           @default(now()) @map("registration_date")
  lastLoginDate           DateTime?          @map("last_login_date")
  currentStreak           Int                @default(0) @map("current_streak")
  totalPredictions        Int                @default(0) @map("total_predictions")
  leaguePlayerStatus      LeaguePlayerStatus @default(NONE) @map("league_player_status")
  leaguePlayerRequestedAt DateTime?          @map("league_player_requested_at")
  leaguePlayerVerifiedAt  DateTime?          @map("league_player_verified_at")
  leaguePlayerId          Int?               @map("league_player_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  predictions         Prediction[]
  predictionEntries   PredictionEntry[]
  achievements        UserAchievement[]
  achievementProgress UserAchievementProgress[]
  predictionStreak    PredictionStreak?
  userRating          UserRating?
  ratingSnapshots     RatingSnapshot[]
  pointAdjustments    AdminPointAdjustment[]
  actionLogs          AdminActionLog[]
  dailyRewardClaims   DailyRewardClaim[]
  leaguePlayer        Person?                   @relation("AppUserLeaguePlayer", fields: [leaguePlayerId], references: [id])
  shopOrders          ShopOrder[]

  @@map("app_user")
}

enum LeaguePlayerStatus {
  NONE
  PENDING
  VERIFIED
}

model Prediction {
  id             BigInt            @id @default(autoincrement()) @map("prediction_id")
  userId         Int               @map("user_id")
  matchId        BigInt            @map("match_id")
  predictionDate DateTime          @map("prediction_date")
  result1x2      PredictionResult? @map("result_1x2")
  totalGoalsOver Float?            @map("total_goals_over")
  penaltyYes     Boolean?          @map("penalty_yes")
  redCardYes     Boolean?          @map("red_card_yes")
  isCorrect      Boolean?          @map("is_correct")
  pointsAwarded  Int               @default(0) @map("points_awarded")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user  AppUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  match Match   @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@unique([userId, matchId])
  @@map("prediction")
}

enum PredictionResult {
  ONE
  DRAW
  TWO
}

enum PredictionMarketType {
  MATCH_OUTCOME
  TOTAL_GOALS
  CUSTOM_BOOLEAN
}

enum PredictionEntryStatus {
  PENDING
  WON
  LOST
  VOID
  CANCELLED
  EXPIRED
}

model PredictionTemplate {
  id                   BigInt               @id @default(autoincrement()) @map("prediction_template_id")
  matchId              BigInt               @map("match_id")
  marketType           PredictionMarketType @map("market_type")
  options              Json                 @map("options")
  basePoints           Int                  @default(0) @map("base_points")
  difficultyMultiplier Decimal              @default(1.0) @map("difficulty_multiplier")
  isManual             Boolean              @default(false) @map("is_manual")
  createdBy            String?              @map("created_by")
  createdAt            DateTime             @default(now()) @map("created_at")
  updatedAt            DateTime             @updatedAt @map("updated_at")

  match   Match             @relation(fields: [matchId], references: [id], onDelete: Cascade)
  entries PredictionEntry[]

  @@index([matchId, marketType], map: "prediction_template_match_market_idx")
  @@map("prediction_template")
}

model PredictionEntry {
  id             BigInt                @id @default(autoincrement()) @map("prediction_entry_id")
  templateId     BigInt                @map("template_id")
  userId         Int                   @map("user_id")
  selection      String                @map("selection")
  submittedAt    DateTime              @default(now()) @map("submitted_at")
  scoreAwarded   Int?                  @map("score_awarded")
  status         PredictionEntryStatus @default(PENDING)
  resolutionMeta Json?                 @map("resolution_meta")
  resolvedAt     DateTime?             @map("resolved_at")
  createdAt      DateTime              @default(now()) @map("created_at")

  template PredictionTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  user     AppUser            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, templateId], map: "prediction_entry_user_template_unique")
  @@index([templateId, status], map: "prediction_entry_template_status_idx")
  @@map("prediction_entry")
}

model PredictionStreak {
  userId           Int       @id @map("user_id")
  currentStreak    Int       @default(0) @map("current_streak")
  maxStreak        Int       @default(0) @map("max_streak")
  lastPredictionAt DateTime? @map("last_prediction_at")
  lastResolvedAt   DateTime? @map("last_resolved_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  createdAt        DateTime  @default(now()) @map("created_at")

  user AppUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("prediction_streak")
}

model AchievementLevel {
  id            Int      @id @default(autoincrement()) @map("achievement_level_id")
  achievementId Int      @map("achievement_id")
  level         Int      @map("level")
  threshold     Int      @map("threshold")
  iconUrl       String?  @map("icon_url")
  title         String   @map("title")
  description   String?  @map("description")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  achievement AchievementType @relation("AchievementTypeLevels", fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([achievementId, level], name: "achievement_level_unique")
  @@map("achievement_level")
}

model UserAchievementProgress {
  id             BigInt    @id @default(autoincrement()) @map("achievement_progress_id")
  userId         Int       @map("user_id")
  achievementId  Int       @map("achievement_id")
  currentLevel   Int       @default(0) @map("current_level")
  progressCount  Int       @default(0) @map("progress_count")
  lastUnlockedAt DateTime? @map("last_unlocked_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  user        AppUser         @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement AchievementType @relation("AchievementTypeProgress", fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId], name: "achievement_progress_unique")
  @@map("achievement_progress")
}

enum RatingScope {
  CURRENT
  YEARLY
}

enum RatingLevel {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
  MYTHIC
}

model UserRating {
  userId             Int         @id @map("user_id")
  totalPoints        Int         @default(0) @map("total_points")
  seasonalPoints     Int         @default(0) @map("seasonal_points")
  yearlyPoints       Int         @default(0) @map("yearly_points")
  mythicRank         Int?        @map("mythic_rank")
  currentLevel       RatingLevel @default(BRONZE) @map("current_level")
  predictionCount    Int         @default(0) @map("prediction_count")
  predictionWins     Int         @default(0) @map("prediction_wins")
  lastRecalculatedAt DateTime?   @map("last_recalculated_at")
  createdAt          DateTime    @default(now()) @map("created_at")
  updatedAt          DateTime    @updatedAt @map("updated_at")

  user AppUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_rating")
}

model RatingSnapshot {
  id         BigInt      @id @default(autoincrement()) @map("rating_snapshot_id")
  userId     Int         @map("user_id")
  scope      RatingScope @map("scope")
  rank       Int         @map("rank")
  points     Int         @map("points")
  capturedAt DateTime    @map("captured_at")
  payload    Json?       @map("payload")

  user AppUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([scope, capturedAt], map: "rating_snapshot_scope_captured_idx")
  @@map("rating_snapshot")
}

model RatingSettings {
  id               Int      @id @default(autoincrement()) @map("rating_settings_id")
  currentScopeDays Int      @map("current_scope_days")
  yearlyScopeDays  Int      @map("yearly_scope_days")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("rating_settings")
}

model RatingSeason {
  id           BigInt      @id @default(autoincrement()) @map("rating_season_id")
  scope        RatingScope @map("scope")
  startsAt     DateTime    @map("starts_at")
  endsAt       DateTime    @map("ends_at")
  closedAt     DateTime?   @map("closed_at")
  durationDays Int         @map("duration_days")
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  winners RatingSeasonWinner[]

  @@index([scope, startsAt], map: "rating_season_scope_start_idx")
  @@index([scope, closedAt], map: "rating_season_scope_closed_idx")
  @@map("rating_season")
}

model RatingSeasonWinner {
  id              BigInt       @id @default(autoincrement()) @map("rating_season_winner_id")
  seasonId        BigInt       @map("season_id")
  userId          Int          @map("user_id")
  rank            Int          @map("rank")
  scopePoints     Int          @map("scope_points")
  totalPoints     Int          @map("total_points")
  predictionCount Int          @default(0) @map("prediction_count")
  predictionWins  Int          @default(0) @map("prediction_wins")
  displayName     String       @map("display_name")
  username        String?      @map("username")
  photoUrl        String?      @map("photo_url")
  createdAt       DateTime     @default(now()) @map("created_at")

  season RatingSeason @relation(fields: [seasonId], references: [id], onDelete: Cascade)

  @@unique([seasonId, rank], map: "rating_season_winner_season_rank_unique")
  @@index([userId, seasonId], map: "rating_season_winner_user_idx")
  @@map("rating_season_winner")
}

model AdminPointAdjustment {
  id              BigInt       @id @default(autoincrement()) @map("point_adjustment_id")
  userId          Int          @map("user_id")
  adminIdentifier String       @map("admin_identifier")
  delta           Int          @map("delta")
  scope           RatingScope? @map("scope")
  reason          String?      @map("reason")
  matchId         BigInt?      @map("match_id")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  user AppUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt], map: "point_adjustment_user_created_idx")
  @@map("admin_point_adjustment")
}

model AdminActionLog {
  id              BigInt    @id @default(autoincrement()) @map("admin_action_log_id")
  userId          Int?      @map("user_id")
  adminIdentifier String    @map("admin_identifier")
  actionType      String    @map("action_type")
  targetType      String?   @map("target_type")
  targetId        String?   @map("target_id")
  metadata        Json?     @map("metadata")
  createdAt       DateTime  @default(now()) @map("created_at")
  expiresAt       DateTime? @map("expires_at")

  user AppUser? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([createdAt], map: "admin_action_log_created_idx")
  @@map("admin_action_log")
}

model AchievementType {
  id            Int               @id @default(autoincrement()) @map("achievement_type_id")
  name          String
  description   String?
  requiredValue Int               @map("required_value")
  metric        AchievementMetric

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users    UserAchievement[]         @relation("AchievementTypeAchievements")
  levels   AchievementLevel[]        @relation("AchievementTypeLevels")
  progress UserAchievementProgress[] @relation("AchievementTypeProgress")

  @@map("achievement_type")
}

enum AchievementMetric {
  DAILY_LOGIN
  TOTAL_PREDICTIONS
  CORRECT_PREDICTIONS
}

model UserAchievement {
  userId            Int      @map("user_id")
  achievementTypeId Int      @map("achievement_type_id")
  achievedDate      DateTime @map("achieved_date")

  user            AppUser         @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievementType AchievementType @relation("AchievementTypeAchievements", fields: [achievementTypeId], references: [id], onDelete: Cascade)

  @@id([userId, achievementTypeId])
  @@map("user_achievement")
}

model DailyRewardClaim {
  id            BigInt   @id @default(autoincrement()) @map("daily_reward_claim_id")
  userId        Int      @map("user_id")
  dayNumber     Int      @map("day_number")
  streakAfter   Int      @map("streak_after")
  pointsAwarded Int      @map("points_awarded")
  claimDateKey  String   @db.VarChar(16) @map("claim_date_key")
  animationKey  String   @db.VarChar(32) @map("animation_key")
  claimedAt     DateTime @default(now()) @map("claimed_at")
  metadata      Json?    @map("metadata")

  user AppUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, claimDateKey], map: "daily_reward_unique_day")
  @@index([claimDateKey], map: "daily_reward_date_idx")
  @@map("daily_reward_claim")
}

model News {
  id             BigInt   @id @default(autoincrement()) @map("news_id")
  title          String   @db.VarChar(100)
  content        String   @db.Text
  coverUrl       String?  @map("cover_url")
  sendToTelegram Boolean  @default(false) @map("send_to_telegram")
  createdAt      DateTime @default(now()) @map("created_at")

  @@index([createdAt(sort: Desc)], map: "news_created_at_desc")
  @@map("news")
}

model AdBanner {
  id           BigInt    @id @default(autoincrement()) @map("ad_banner_id")
  title        String    @db.VarChar(80)
  subtitle     String?   @db.VarChar(160)
  targetUrl    String?   @map("target_url")
  imageData    Bytes     @map("image_data")
  imageMime    String    @map("image_mime")
  imageWidth   Int       @map("image_width")
  imageHeight  Int       @map("image_height")
  imageSize    Int       @map("image_size")
  displayOrder Int       @default(0) @map("display_order")
  isActive     Boolean   @default(true) @map("is_active")
  startsAt     DateTime? @map("starts_at")
  endsAt       DateTime? @map("ends_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@index([isActive, displayOrder, updatedAt], map: "ad_banner_active_order")
  @@map("ad_banner")
}

model ShopItem {
  id            Int      @id @default(autoincrement()) @map("shop_item_id")
  slug          String?  @unique(map: "shop_item_slug_unique")
  title         String   @db.VarChar(80)
  subtitle      String?  @db.VarChar(160)
  description   String?  @db.Text
  priceCents    Int      @map("price_cents")
  currencyCode  String   @default("RUB") @map("currency_code")
  stockQuantity Int?     @map("stock_quantity")
  maxPerOrder   Int      @default(3) @map("max_per_order")
  sortOrder     Int      @default(100) @map("sort_order")
  isActive      Boolean  @default(true) @map("is_active")
  imageUrl      String?  @map("image_url")
  imageData     Bytes?   @map("image_data")
  imageMime     String?  @map("image_mime")
  imageWidth    Int?     @map("image_width")
  imageHeight   Int?     @map("image_height")
  imageSize     Int?     @map("image_size")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  orders ShopOrderItem[]

  @@index([isActive, sortOrder], map: "shop_item_active_order_idx")
  @@map("shop_item")
}

model ShopOrder {
  id           BigInt          @id @default(autoincrement()) @map("shop_order_id")
  orderNumber  String          @unique @map("order_number")
  userId       Int?            @map("user_id")
  telegramId   BigInt?         @map("telegram_id")
  username     String?         @map("username")
  firstName    String?         @map("first_name")
  status       ShopOrderStatus @default(PENDING)
  totalCents   Int             @map("total_cents")
  currencyCode String          @default("RUB") @map("currency_code")
  customerNote String?         @map("customer_note")
  confirmedAt  DateTime?       @map("confirmed_at")
  confirmedBy  String?         @map("confirmed_by")
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  user  AppUser?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  items ShopOrderItem[]

  @@index([status, createdAt], map: "shop_order_status_created_idx")
  @@map("shop_order")
}

model ShopOrderItem {
  id         BigInt  @id @default(autoincrement()) @map("shop_order_item_id")
  orderId    BigInt  @map("order_id")
  itemId     Int     @map("item_id")
  title      String  @db.VarChar(80)
  subtitle   String? @db.VarChar(160)
  priceCents Int     @map("price_cents")
  quantity   Int     @map("quantity")
  imageUrl   String? @map("image_url")

  order ShopOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  item  ShopItem  @relation(fields: [itemId], references: [id], onDelete: Restrict)

  @@index([orderId], map: "shop_order_item_order_idx")
  @@index([itemId], map: "shop_order_item_item_idx")
  @@map("shop_order_item")
}

enum ShopOrderStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

model Disqualification {
  id                 BigInt                 @id @default(autoincrement()) @map("disqualification_id")
  personId           Int                    @map("person_id")
  clubId             Int?                   @map("club_id")
  reason             DisqualificationReason
  sanctionDate       DateTime               @map("sanction_date")
  banDurationMatches Int                    @map("ban_duration_matches")
  matchesMissed      Int                    @default(0) @map("matches_missed")
  isActive           Boolean                @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  person Person @relation(fields: [personId], references: [id], onDelete: Cascade)
  club   Club?  @relation(fields: [clubId], references: [id], onDelete: SetNull)

  @@map("disqualification")
}

enum DisqualificationReason {
  RED_CARD
  SECOND_YELLOW
  ACCUMULATED_CARDS
  OTHER
}
