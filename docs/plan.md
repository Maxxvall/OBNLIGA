
# План развёртывания прогнозов и рейтинга

## Цели
- Внедрить лиговый игровой режим прогнозов с закрытой логикой начисления очков и видимыми простыми вариантами выбора (1, X, 2 и тоталы больше/меньше)
- Реализовать многоуровневую систему достижений с логикой на основе серий (streaks) и иконками, управляемыми через админ-панель
- Обеспечить эффективное потребление ресурсов между PostgreSQL, Prisma ORM, Redis-кэшем и существующими WS/HTTP-слоями при гарантии актуальности данных
- Интегрировать представления рейтингов (текущий и годовой) в публичный фронтенд без терминологии коэффициентов и с UX, соответствующим требованиям российского рынка
- Предоставить операторам админ-инструменты для настройки тоталов, достижений, аварийных оверрайдов и аудита через существующую WS-инфраструктуру

## Наблюдения по текущей системе
- Админ-приложение использует Zustand-store с подсказками TTL для fetch (`admin/src/store/adminStore.ts`) и обновления через WS-топики для новостей; массивы прогнозов и достижений уже существуют, но не полностью заполнены
- Фронтенд-апп экспонирует вкладки (Profile, LineupPortal) с API-клиентами под `frontend/src/api`; пользовательские вкладки полагаются на REST-запросы — необходимо добавить поддержку ETag/If-None-Match для каждого эндпойнта
- Бэкенд использует роуты в стиле Fastify под `backend/src/routes`; утилиты кэширования (`backend/src/cache`) уже инкапсулируют Redis и многоуровневые шаблоны кэширования; схема Prisma находится в `prisma/schema.prisma`
- Общие типы (`shared/types.ts`) синхронизируют DTO между сервисами

## Добавления в модель данных
- Расширить `prisma/schema.prisma` следующими моделями:
  - `PredictionTemplate` — конфигурация рынка для конкретного матча (1X2, тоталы). Поля: `id`, `matchId`, `marketType`, `options`, `basePoints`, `difficultyMultiplier`, `isManual`, `createdBy`, временные метки
  - `PredictionEntry` — пользовательские отправки прогнозов. Поля: `id`, `userId`, `templateId`, `selection`, `submittedAt`, `scoreAwarded`, `status`, `resolvedAt`
  - `PredictionStreak` — отслеживание серий. Поля: `userId`, `currentStreak`, `maxStreak`, `lastPredictionAt`, `lastResolvedAt`
  - `AchievementType` — обогащённая информацией об уровнях. Новая таблица `AchievementLevel`: `id`, `achievementId`, `level`, `threshold`, `icon`, `title`, `description`
  - `UserAchievementProgress`: `id`, `userId`, `achievementId`, `currentLevel`, `progressCount`, `lastUnlockedAt`
  - `UserRating`: `userId`, `totalPoints`, `seasonalPoints`, `yearlyPoints`, `mythicRank`, `lastRecalculatedAt`
  - `RatingSnapshot`: `id`, `userId`, `scope` (`current`, `yearly`), `rank`, `points`, `capturedAt` — для аудита и кэширования
  - Метаданные для аудита: `AdminPointAdjustment` (`id`, `adminId`, `userId`, `delta`, `reason`, `scope`, временные метки), `AdminActionLog` для фиксации ручных операций и обеспечения отката в течение 72 часов
- Добавить составные индексы: `PredictionEntry(userId, templateId)`, `PredictionEntry(templateId, status)`, `PredictionStreak(userId)`, `UserRating(totalPoints DESC)`, `RatingSnapshot(scope, capturedAt)`

## План работ на бэкенде
- Фаза 0: Схема и миграции
  - Добавить модели в Prisma, выполнить поэтапные миграции, засеять дефолтные достижения и скрытые коэффициенты для начисления очков
  - Обновить общие типы новыми DTO и перечислениями (enums)
- Фаза 1: Приём прогнозов
  - Сервис `predictionService` для создания шаблонов на матч на основе конвейера данных; интеграция с планировщиком матчей для вычисления тоталов — ✅ 2025-11-03 (автогенерация `predictionTemplateService` при запросах)
  - Реализовать динамический калькулятор тоталов (считывая последние 5 матчей; запасной вариант 2.5) в `backend/src/services/predictionTotalsService.ts` — ✅ 2025-11-03
  - Открыть админ-роут для оверрайда тоталов (`PATCH /admin/matches/:id/prediction-template`) — ✅ 2025-11-03
- Фаза 2: Движок начисления очков
  - ✅ Расчёт очков и статусов выполняется при финализации матча через `settlePredictionEntries`; поддержаны рынки исхода, тоталов и кастомных событий с мультипликаторами сложности
  - ✅ После расчёта обновляются `PredictionEntry`, streak, выполняется точечный пересчёт `UserRating` и инвалидация пользовательских/публичных кэшей рейтинга
  - План: вынести расчёт в фонового воркера, если потребуется разгрузка онлайнового пути
- Фаза 3: Агрегация рейтинга
  - ✅ задача в очереди каждые 6 часов для рекалькуляции рангов и обновления `RatingSnapshot`; применять сброс годовых очков 1 мая и квартальный сброс для текущего scope
  - ✅ Предоставить API-эндпойнты для получения таблиц лидеров с пагинацией и поддержкой ETag
- Фаза 4: Админ-контрольные приложения
  - Расширить админ-роуты для управления достижениями; защитить ролями (role-based guards), которые уже присутствуют
- Фаза 5: Интеграция фронтенда
  - Пользовательские API-эндпойнты для перечисления активных шаблонов прогнозов, отправки выборов, получения истории, достижений (достижения будут отображаться на вкладке профиль) и рейтинга
  - Реализовать HTTP-кэширование с использованием `Last-Modified` и `ETag` плюс Redis TTL-кэши для публичных read-эндпойнтов (например, TTL 60s для таблицы лидеров, 60s для списков прогнозов). Всегда сбрасывать кэши при релевантных записях

## Реализация в админ-панели
- Вкладки
  - Разделить существующую вкладку Users & Activity на выделенные вкладки: `Predictions`, `Achievements`, `Emergency`
  - Вкладка `Predictions` показывает предстоящие матчи с вычисленными тоталами; контролы для переключения между авто/ручными тоталами и редактирования мультипликаторов сложности — ✅ собран экран, добавлены сезонный фильтр, формы ручного режима и быстрый возврат к автоматике
    - ✅ Матчи ограничены ближайшими 6 днями, названия клубов отображаются полностью, калькулятор подсказывает альтернативные линии (±1 гол) для ручной настройки
    - ✅ Бэкенд готов: `GET /api/admin/predictions/matches` возвращает шаблоны и подсказки тоталов; в Zustand добавлены `fetchPredictionMatches`, `setPredictionTemplateAuto/Manual`
  - Вкладка `Achievements` позволяет CRUD для типов достижений, порогов уровней, загрузки иконок (повторно используя существующие upload-API) и ручной корректировки прогресса
  - Вкладка `Ratings` показывает текущие окна расчёта, форму изменения периодов и пагинированный лидерборд. ✅ Собрана вкладка с формой редактирования окон, ручным пересчётом, переключателями `current/yearly`, пагинацией и привязкой к действиям `fetchRatingSettings`, `fetchRatingLeaderboard`, `setRatingScope`, `setRatingPagination`, `updateRatingSettings`, `recalculateRatings`.
  - Вкладка `Emergency` предоставляет регулирование очков, сбросы серий и представление откатов (с фильтрами по логам). Обязательные диалоги подтверждения и поле "причина"
- Поток данных
  - Переиспользовать паттерн Zustand с TTL; задать `FETCH_TTL` по области (predictions 20s, ratingSettings 60s, ratingLeaderboard 30s, achievements 2m, emergency logs 15s). Обновлять кэши при поступлении WS-patch — ✅ реализовано для предстоящих матчей прогнозов, рейтинг временно обновляется явным refetch после мутаций
  - Подписаться на новые WS-топики `admin.predictions` и `admin.achievements` для инкрементальных обновлений — ✅ подписка `admin.predictions` добавлена, остаётся `admin.achievements`
  - Отображать историю аудита в таблицах (колонки: user, action, delta, timestamp, admin)

## Фронтенд (пользовательская часть)
- Вкладка прогнозов
  - Роут `/predictions`, получающий шаблоны через `GET /predictions/active` с TTL-кэшированием (Redis 15s). Использовать условные запросы (ETag/If-None-Match); в случае совпадения возвращать `304` для минимизации трафика
  - ✅ Обновлён UI вкладки: пользователю доступен компактный список рынков без коэффициентов, добавлены спец события (пенальти, красная) и разметка под очки/сложность при сохранении существующей логики отправки `POST /predictions/:templateId/entry`
  - ✅ Стилистика вкладки приведена к виду вкладки Лиги (единый хедер, табы, акцентные цвета)
  - Отображать ожидающие и разрешённые прогнозы; показывать прогресс серии и подсказки по достижениям без раскрытия мультипликаторов начисления
- Вкладка рейтинга
  - Роут `/ratings` показывает текущую и годовую таблицы лидеров; вызывать `GET /ratings?scope=current|yearly`. Поддерживать бесконечную прокрутку или пагинацию. Показывать бейджи уровня пользователя на основании порогов
  - ✅ Обновлён хедер и переключатели вкладки рейтинга под лиговый стиль; актуализация запускает инвалидацию кэшей после перерасчёта очков
  - Интегрировать сводку рейтинга в хедер профиля (обод вокруг аватара через CSS) используя данные из `GET /users/me/rating`
- Модуль достижений
  - Раздел профиля, показывающий разблокированные уровни; данные из `GET /users/me/achievements`. Кэшировать с TTL 60s, но всегда обходить кэш после мутаций через `Cache-Control: no-cache` в ответах на мутации
- Кэширование на клиенте
  - Использовать `react-query` или существующий стор для сохранения TTL; полагаться на серверные заголовки `Cache-Control: max-age=15` и `ETag` для прогнозов, `max-age=300` для достижений
  - Обрабатывать `304` сохраняя локальное состояние; интегрировать фоновой рефреш после WS-события с long-poll fallback, если WS недоступен

## Эффективность ресурсов и стратегия кэширования
- Использование Redis
  - Хранить предвычисленные динамические тоталы и снимки таблиц лидеров с хешированными ключами (`predictions:match:{id}`, `leaderboard:scope:{scope}`). Задавать TTL 30s–2m в зависимости от изменчивости
  - Использовать Redis streams или pub/sub для сигналов инвалидации, которые потребляет админ WS-слой
- Нагрузка на БД
  - Батчить записи от scoring-движка, используя транзакции Prisma на матч; убедиться, что индексы снижают количество поисков
  - Для перерасчёта серий получать только затронутых пользователей (задача разрешения знает победителей/проигравших)
- HTTP-кэширование
  - Генерировать ETag на основе хэша `updatedAt` для эндпойнтов прогнозов и рейтингов
  - Возвращать `304 Not Modified` при совпадении `If-None-Match`, в сочетании с `Cache-Control: public, max-age=15`
- Эффективность WebSocket
  - Админ-WS уже активен; ввести топик-ориентированные патчи с компактными нагрузками (только ID), чтобы клиенты перезапрашивали данные — это снизит нагрузку

## Операционные соображения
  - Предоставить UI `AdminActionLog` для отката корректировок в течение 24 часов путем проигрывания обратных операций
- Документация
  - Обновить `docs/cache.md`, подробно описав новые TTL и workflow инвалидации
  - Добавить runbook для отладки прогнозов (зависшие матчи, ошибочно вычисленные тоталы)

## Предложения по улучшению
- Рассмотреть предвычисление данных форм для мини-игр (например, миссии-стрик) и доставку через CDN JSON, чтобы снизить нагрузку в дни матчей
- Расширить shared types, чтобы покрыть новые DTO и обеспечить безопасность на этапе компиляции между админом и фронтендом
- Пересмотреть настройки пула соединений Prisma для обеспечения запаса производительности под новые write-heavy потоки (использовать pgbouncer или пуллинг соединений в продакшене)
