# TTL и HTTP polling справочник

Обновлено: 2025-10-15

Документ фиксирует клиентские TTL, интервалы polling и правила обработки ответов `200 OK` / `304 Not Modified` после перехода на HTTP polling с ETag в публичном приложении.

## Публичный клиент (`frontend`)

### `/api/league/seasons`
- TTL: 55 000 мс (55 с). Применяется при любом успешном ответе.
- Поллинг: по требованию, при первом входе во вкладку «Лига» и при смене сезона (`fetchLeagueSeasons`).
- Заголовок запроса: `If-None-Match: <seasonsVersion>` если версия уже сохранена.
- Ответ `200 OK`: список сезонов сортируется по дате начала, неизменившиеся сущности переиспользуются (через `reuseSeason`), версия обновляется в `seasonsVersion`, `activeSeasonId` синхронизируется с активным сезоном сервера.
- Ответ `304`: обновляется только `seasonsFetchedAt`, состояние не меняется.

### `/api/league/table?seasonId={id}`
- TTL: 30 000 мс (30 с) на каждый сезон.
- Поллинг: каждые 10 с, пока открыта вкладка «Лига» и пользователь находится на подвкладке «Таблица» (функция `ensureLeaguePolling`).
- Заголовок запроса: `If-None-Match: <tableVersions[id]>`.
- Ответ `200 OK`: таблица объединяется через `mergeLeagueTable`, что сохраняет ссылки на неизменившиеся строки; версия сохраняется в `tableVersions[id]`, метка обновляется в `tableFetchedAt[id]`, при необходимости корректируется `activeSeasonId`.
- Ответ `304`: сбрасывается флаг загрузки, обновляется `tableFetchedAt[id]`, данные не трогаются.

### `/api/league/schedule?seasonId={id}`
- TTL: 12 000 мс (12 с) на каждый сезон.
- Поллинг: каждые 10 с, но только если активна подвкладка «Расписание».
- Заголовок запроса: `If-None-Match: <scheduleVersions[id]>`.
- Ответ `200 OK`: расписание сливается через `mergeRoundCollection`, переиспользуя матчи и метаданные раундов; версия записывается в `scheduleVersions[id]`.
- Ответ `304`: обновляется `scheduleFetchedAt[id]`, ссылки в состоянии не меняются.

### `/api/league/results?seasonId={id}`
- TTL: 20 000 мс (20 с) на каждый сезон.
- Поллинг: каждые 10 с, но только если активна подвкладка «Результаты».
- Заголовок запроса: `If-None-Match: <resultsVersions[id]>`.
- Ответ `200 OK`: данные проходят через `mergeRoundCollection` (тот же алгоритм, что и для расписания), обновляются `results[id]`, `resultsVersions[id]`, `resultsFetchedAt[id]`, возможна корректировка `activeSeasonId`.
- Ответ `304`: обновляется только `resultsFetchedAt[id]`.

### `/api/league/stats?seasonId={id}`
- TTL: 300 000 мс (5 мин) на каждый сезон.
- Поллинг: каждые 10 с при активной подвкладке «Статистика»; при отсутствии активности опрос не выполняется.
- Заголовок запроса: `If-None-Match: <statsVersions[id]>`.
- Ответ `200 OK`: лидерборды объединяются через `mergeStatsResponse` с сохранением ссылок на неизменившихся игроков; версия фиксируется в `statsVersions[id]`.
- Ответ `304`: обновляется `statsFetchedAt[id]`, данные остаются прежними.

### `/api/clubs/{id}/summary`
- TTL: 45 000 мс (45 с) для каждого клуба.
- Поллинг: каждые 20 с, пока открыт Team View выбранного клуба (`ensureTeamPolling`).
- Заголовок запроса: `If-None-Match: <teamSummaryVersions[id]>`.
- Ответ `200 OK`: payload валидируется (`isClubSummaryResponsePayload`), затем сохраняется в `teamSummaries[id]`, версия в `teamSummaryVersions[id]`, таймстемп в `teamSummaryFetchedAt[id]`, ошибки очищаются.
- Ответ `304`: обновляется только `teamSummaryFetchedAt[id]`; polling остаётся активным.

### `/api/clubs/{id}/matches`
- TTL: 90 000 мс (90 с) для каждого клуба.
- Поллинг: каждые 20 с вместе со сводкой (`ensureTeamPolling`).
- Заголовок запроса: `If-None-Match: <teamMatchesVersions[id]>`.
- Ответ `200 OK`: payload валидируется (`isClubMatchesResponsePayload`) и сохраняется в `teamMatches[id]`, версия фиксируется в `teamMatchesVersions[id]`, таймстемп — в `teamMatchesFetchedAt[id]`.
- Ответ `304`: продлевается `teamMatchesFetchedAt[id]`, данные и группы сезонов переиспользуются без изменений.

### `/api/news`
- TTL: 60 000 мс между запросами + локальный cache в `localStorage` на 30 минут.
- Поллинг: всегда в фоне, если вкладка активна (компонент `NewsSection`), с проверкой `document.hidden`.
- Заголовок запроса: `If-None-Match` отправляется, когда компоненту известен предыдущий `ETag` и API обслуживается тем же доменом.
- Ответ `200 OK`: карточки новостей складываются в `localStorage` вместе с `ETag`, состояние обновляется целиком.
- Ответ `304`: метки времени продлеваются, список новостей не переписывается.

### `/api/auth/telegram-init` и `/api/auth/me`
- TTL: 90 000 мс между запросами в режиме polling (`PROFILE_REFRESH_INTERVAL_MS`), локальный cache — 5 минут.
- Поллинг: только при открытой вкладке «Профиль».
- Заголовки: `If-None-Match` добавляется к `telegram-init`, если сохранён `etag` из предыдущего ответа. Для `GET /api/auth/me` conditional-запросы не используются, запрос выполняется по необходимости.
- Ответ `200 OK`: профиль записывается в `localStorage`, `ETag` обновляется, UI сразу отображает свежие данные.
- Ответ `304`: используется локальный snapshot, таймеры продлеваются, чтобы не дергать сервер повторно.

### `/api/league/stats` → лидерборды
- Лидерборды находятся внутри ответа `/api/league/stats`, отдельный endpoint не выделяется.
- Все merge-хелперы сравнивают записи по ключу `personId:clubId` и переиспользуют ссылки для неизменившихся игроков.

## Общие правила обработки

- Любой `304 Not Modified` приводит только к обновлению таймстемпа и снятию флага `loading`; ссылки на данные не меняются.
- После `200 OK` все merge-хелперы обязаны возвращать уже существующие ссылки на неизменившиеся элементы, чтобы избежать лишних перерисовок React.
- При `ok: false` store фиксирует код ошибки в соответствующем словаре (`errors` или `teamSummaryErrors`) и не продлевает TTL — чтобы следующий успешный запрос сработал сразу.
- Все запросы выполняются через `httpRequest`, поэтому наличие версии в `meta.version`, `ETag` или `X-Resource-Version` критично. Отсутствие версии считается ошибкой API.

## Дополнительные интервалы

- Вкладка «Профиль» (`frontend/src/Profile.tsx`) обновляет данные каждые 90 000 мс, conditional-запросы отправляются только если есть `ETag` после прошлого логина.
- Компонент новостей (`frontend/src/components/NewsSection.tsx`) опрашивает API каждые 60 000 мс, хранит snapshot и `ETag` в `localStorage` и при `304` лишь продлевает TTL.
- Главная страница (`home`) не имеет отдельного стора — она потребляет данные лиги/новостей, поэтому дополнительные запросы не инициируются.
