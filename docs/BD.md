## **Схема Базы Данных для Футбольной Лиги (Локальная версия)**

Схема оптимизирована для небольшого количества лиг в рамках одного города.

### **1\. Базовые Справочники (Foundation)**

| Таблица | Поле | Тип данных | Описание | Отношения |
| :---- | :---- | :---- | :---- | :---- |
| **Клуб (Club)** | club\_id | INT (PK) | Уникальный идентификатор клуба. | \- |
|  | name | VARCHAR(255) | Официальное название клуба. | \- |
|  | short\_name | VARCHAR(50) | Сокращенное название клуба. | \- |
|  | logo\_url | VARCHAR(255) | Ссылка на логотип. | \- |
| **Персона (Person)** | person\_id | INT (PK) | Уникальный идентификатор (игроки, судьи). | \- |
|  | first\_name | VARCHAR(100) | Имя. | \- |
|  | last\_name | VARCHAR(100) | Фамилия. | \- |
|  | is\_player | BOOLEAN | Флаг: является ли игроком. | \- |
| **Шаблон состава клуба (Club\_Player)** | club\_id | INT (PK, FK) | Клуб, к которому привязан игрок. | \-\> Клуб |
|  | person\_id | INT (PK, FK) | Игрок, закреплённый за клубом. | \-\> Персона |
|  | default\_shirt\_number | INT | Базовый номер для автозаявки (опционально). | \- |

### **2\. Структура Турниров (Competition Structure)**

| Таблица | Поле | Тип данных | Описание | Отношения |
| :---- | :---- | :---- | :---- | :---- |
| **Турнир (Competition)** | competition\_id | INT (PK) | Уникальный ID турнира (напр. "Высшая Лига", "1я Лига"). | \- |
|  | name | VARCHAR(255) | Название турнира. | \- |
|  | type | ENUM | Тип ('LEAGUE', 'CUP'). | \- |
|  | **series_format** | **ENUM** | **Формат регулярки/плей-офф:** 'SINGLE_MATCH', 'TWO_LEGGED', 'BEST_OF_N', 'DOUBLE_ROUND_PLAYOFF', 'PLAYOFF_BRACKET'. | \- |
| **Сезон (Season)** | season\_id | INT (PK) | Уникальный ID конкретного розыгрыша (напр. "Высшая Лига 2024"). | \- |
|  | competition\_id | INT (FK) | Ссылка на родительский турнир. | \-\> Турнир |
|  | name | VARCHAR(100) | Название сезона (напр. '2024'). | \- |
|  | start\_date | DATE | Дата начала сезона. | \- |
|  | end\_date | DATE | Дата окончания сезона. | \- |
|  | series\_format | ENUM | Формат серий конкретного сезона; при наличии перекрывает настройку турнира. | \- |
| **Участник\_Сезона (Season\_Participant)** | season\_id | INT (PK, FK) | Ссылка на сезон. | \-\> Сезон |
|  | club\_id | INT (PK, FK) | Ссылка на участвующий клуб. | \-\> Клуб |

### **2.5 Заявка на Сезон (Roster)**

| Таблица | Поле | Тип данных | Описание | Отношения |
| :---- | :---- | :---- | :---- | :---- |
| **Заявка\_Сезона (Season\_Roster)** | season\_id | INT (PK, FK) | Сезон, на который подана заявка. | \-\> Сезон |
|  | club\_id | INT (PK, FK) | Клуб, подавший заявку. | \-\> Клуб |
|  | person\_id | INT (PK, FK) | Игрок в заявке. | \-\> Персона |
|  | shirt\_number | INT | Игровой номер в этом сезоне (1-99). | \- |
|  | registration\_date | DATE | Дата включения в заявку. | \- |

### **3\. Матчи и Расписание (Matches & Schedule)**

| Таблица | Поле | Тип данных | Описание | Отношения |
| :---- | :---- | :---- | :---- | :---- |
| **Стадион (Stadium)** | stadium\_id | INT (PK) | Уникальный ID стадиона. | \- |
|  | name | VARCHAR(255) | Название стадиона. | \- |
|  | city | VARCHAR(100) | Город. | \- |
| **Серия\_Матчей (Match\_Series)** | **series\\\_id** | **BIGINT (PK)** | **Уникальный ID серии (одно противостояние в плей-офф).** | \- |
|  | **season\\\_id** | **INT (FK)** | **Сезон, к которому относится серия.** | \-\> Сезон |
|  | **stage\\\_name** | **VARCHAR(100)** | **Стадия (напр., '1/4 Финала', 'Групповой Этап').** | \- |
|  | **home\\\_club\\\_id** | **INT (FK)** | **Первый клуб в паре.** | \-\> Клуб |
|  | **away\\\_club\\\_id** | **INT (FK)** | **Второй клуб в паре.** | \-\> Клуб |
|  | **series\\\_status** | **ENUM** | **Статус серии ('IN\_PROGRESS', 'FINISHED').** | \- |
|  | **winner\\\_club\\\_id** | **INT (FK)** | **Победитель серии (NULL, пока серия не завершена).** | \-\> Клуб |
| **Тур Сезона (Season\_Round)** | round\_id | INT (PK) | Уникальный ID тура/стадии. | \- |
|  | season\_id | INT (FK) | Сезон, к которому принадлежит тур. | \-\> Сезон |
|  | round\_type | ENUM | Тип среза: 'REGULAR' (регулярный тур) или 'PLAYOFF'. | \- |
|  | round\_number | INT | Порядковый номер тура (NULL для плей-офф стадий). | \- |
|  | label | VARCHAR(100) | Отображаемое название: `"1 тур"`, `"1/4 финала"` и т.п. | \- |
| **Матч (Match)** | match\_id | BIGINT (PK) | Уникальный ID матча. | \- |
|  | season\_id | INT (FK) | Ссылка на сезон, к которому относится матч. | \-\> Сезон |
|  | **series\\\_id** | **BIGINT (FK)** | **Ссылка на серию (NULL для обычных матчей лиги).** | **\-\> Серия\_Матчей** |
|  | **series\\\_match\\\_number** | **INT** | **Номер матча в серии (1, 2, 3...). NULL для обычных матчей лиги.** | \- |
|  | match\_date\_time | DATETIME | Дата и время начала матча. | \- |
|  | home\_team\_id | INT (FK) | Клуб-хозяин. | \-\> Клуб |
|  | away\_team\_id | INT (FK) | Клуб-гость. | \-\> Клуб |
|  | home\_score | INT | Счет хозяев. | \- |
|  | away\_score | INT | Счет гостей. | \- |
|  | has_penalty_shootout | BOOLEAN | Флаг: серия пенальти сыграна (для матчей плей-офф до двух побед). | \- |
|  | penalty_home_score | INT | Счёт серии пенальти для хозяев (не добавляется в общую статистику). | \- |
|  | penalty_away_score | INT | Счёт серии пенальти для гостей (не добавляется в общую статистику). | \- |
|  | status | ENUM | Статус ('SCHEDULED', 'LIVE', 'FINISHED', 'POSTPONED'). | \- |
|  | stadium\_id | INT (FK) | Место проведения. | \-\> Стадион |
|  | referee\_id | INT (FK) | Главный судья. | \-\> Персона |
|  | round\_id | INT (FK) | Привязка к туру/стадии (может быть NULL для исторических матчей). | \-\> Season\_Round |

### **4\. Детали Матча (In-Depth Match Data)**

| Таблица | Поле | Тип данных | Описание | Отношения |
| :---- | :---- | :---- | :---- | :---- |
| **Состав\_Матча (Match\_Lineup)** | match\_id | BIGINT (PK, FK) | Ссылка на матч. | \-\> Матч |
|  | person\_id | INT (PK, FK) | Ссылка на игрока. | \-\> Персона |
|  | club\_id | INT (FK) | Клуб, за который выступает игрок в этом матче. | \-\> Клуб |
|  | role | ENUM | Роль ('STARTER', 'SUBSTITUTE'). | \- |
|  | position | VARCHAR(50) | Позиция на поле. | \- |
| **Событие\_Матча (Match\_Event)** | event\_id | BIGINT (PK) | Уникальный ID события. | \- |
|  | match\_id | BIGINT (FK) | Ссылка на матч. | \-\> Матч |
|  | team\_id | INT (FK) | Команда, совершившая событие. | \-\> Клуб |
|  | minute | INT | Минута матча. | \- |
|  | event\_type | ENUM | Тип события ('GOAL', 'YELLOW\_CARD', 'RED\_CARD', 'SUB\_IN', 'SUB\_OUT'). | \- |
|  | player\_id | INT (FK) | Игрок, совершивший действие (забил, получил карточку). | \-\> Персона |
|  | related\_player\_id | INT (FK) | Связанный игрок (напр. ассистент для гола, вышедший игрок для замены). | \-\> Персона |

### **5\. Агрегированная Статистика (Aggregated Statistics)**

| Таблица | Поле | Тип данных | Описание | Отношения |
| :---- | :---- | :---- | :---- | :---- |
| **Статистика\_Сезона\_Игрока (Player\_Season\_Stats)** | season\_id | INT (PK, FK) | Ссылка на текущий сезон. | \-\> Сезон |
|  | person\_id | INT (PK, FK) | Ссылка на игрока. | \-\> Персона |
|  | club\_id | INT (FK) | Клуб игрока в этом сезоне. | \-\> Клуб |
|  | goals | INT | Всего голов в сезоне. | \- |
|  | assists | INT | Всего голевых передач в сезоне. | \- |
|  | yellow\_cards | INT | Желтые карточки. | \- |
|  | red\_cards | INT | Красные карточки. | \- |
|  | matches\_played | INT | Количество сыгранных матчей. | \- |
| **Статистика\_Клуба\_Карьеры (Player\_Club\_Career\_Stats)** | person\_id | INT (PK, FK) | Ссылка на игрока. | \-\> Персона |
|  | club\_id | INT (PK, FK) | Ссылка на клуб. | \-\> Клуб |
|  | total\_goals | INT | Общее количество голов за этот клуб. | \- |
|  | total\_assists | INT | Общее количество передач за этот клуб. | \- |
|  | total\_matches | INT | Общее количество матчей за этот клуб. | \- |
|  | yellow\_cards | INT | Количество желтых карточек за карьеру в клубе. | \- |
|  | red\_cards | INT | Количество красных карточек за карьеру в клубе. | \- |
| **Статистика\_Сезона\_Клуба (Club\_Season\_Stats)** | season\_id | INT (PK, FK) | Ссылка на текущий сезон. | \-\> Сезон |
|  | club\_id | INT (PK, FK) | Ссылка на клуб. | \-\> Клуб |
|  | points | INT | Набранные очки. | \- |
|  | wins | INT | Количество побед. | \- |
|  | losses | INT | Количество поражений. | \- |
|  | goals\\\_for | INT | Забитые голы. | \- |
|  | goals\\\_against | INT | Пропущенные голы. | \- |
 
#### **Профиль игрока: leaguePlayerCareer (API payload)**

REST-эндпоинты `/api/auth/telegram-init` и `/api/auth/me` возвращают поле `leaguePlayerCareer` — массив карьерных записей по каждому клубу, где игрок успел сыграть.

| Поле | Тип | Описание |
| :---- | :---- | :---- |
| `clubId` | INT | Идентификатор клуба из таблицы `Club`. |
| `clubName` | VARCHAR | Полное название клуба для отрисовки. |
| `clubShortName` | VARCHAR | Короткое название (используется в компактных таблицах). |
| `clubLogoUrl` | VARCHAR \\ NULL | Ссылка на логотип клуба (может отсутствовать). |
| `fromYear` | INT \\ NULL | Год первой регистрации или первого матча за клуб. |
| `toYear` | INT \\ NULL | Год последней регистрации/матча; `NULL`, если есть активный сезон. |
| `matches` | INT | Количество официальных матчей за клуб. |
| `goals` | INT | Голов за клуб. |
| `assists` | INT | Голевых передач за клуб. |
| `penaltyGoals` | INT | Голы с пенальти. |
| `yellowCards` | INT | Желтые карточки. |
| `redCards` | INT | Красные карточки. |

**Расчет диапазона лет:**

- `fromYear` определяется минимальной датой из регистраций в `Season_Roster`, стартов сезонов (`Season.start_date`) и первого сыгранного матча (`Match.match_date_time`).
- `toYear` берется по максимальной дате из тех же источников. Если хотя бы один сезон по клубу помечен как `is_active = TRUE`, значение остается `NULL` (карьера продолжается). Если активных сезонов нет и даты совпадают, диапазон схлопывается в один год.
- Записи без сыгранных матчей и без активного сезона исключаются из ответа, чтобы не шуметь пустыми строками.

### **6\. Пользователи и Прогнозы (Users & Predictions)**

| Таблица | Поле | Тип данных | Описание | Отношения |
| :---- | :---- | :---- | :---- | :---- |
| **Пользователь_Приложения (App_User)** | user_id | INT (PK) | Уникальный ID пользователя в приложении. | \- |
|  | telegram_id | BIGINT (UNIQUE) | **ID пользователя Telegram** (ключ для аутентификации). | \- |
|  | username | VARCHAR(100) | Username Telegram (может быть NULL). | \- |
|  | first_name | VARCHAR(100) | Имя из Telegram. | \- |
|  | registration_date | DATETIME | Дата регистрации в приложении. | \- |
|  | last_login_date | DATE | Дата последнего входа (для streak'ов). | \- |
|  | current_streak | INT | Текущая серия входов. | \- |
|  | total_predictions | INT | Первый поколение подсчёта прогнозов (для бэккомпат). | \- |
|  | created_at / updated_at | DATETIME | Таймстемпы. | \- |
|  | **Связи** |  | predictionEntries, predictionStreak, userRating, ratingSnapshots, achievementProgress, pointAdjustments, actionLogs | |

| **Шаблон Прогноза (Prediction_Template)** | prediction_template_id | BIGINT (PK) | Конфигурация рынка для матча. | \- |
|  | match_id | BIGINT (FK) | Матч, к которому относится шаблон. | \-\> Match |
|  | market_type | ENUM | Тип рынка: 'MATCH_OUTCOME', 'TOTAL_GOALS', 'CUSTOM_BOOLEAN'. | \- |
|  | options | JSON | Конфигурация вариантов (без публичных коэффициентов). | \- |
|  | base_points | INT | Базовое количество очков. | \- |
|  | difficulty_multiplier | DECIMAL | Скрытый мультипликатор сложности. | \- |
|  | is_manual | BOOLEAN | Флаг ручной настройки. | \- |
|  | created_by | VARCHAR | Идентификатор админа. | \- |

| **Заявка на Прогноз (Prediction_Entry)** | prediction_entry_id | BIGINT (PK) | Конкретный выбор пользователя по шаблону. | \- |
|  | template_id | BIGINT (FK) | Ссылка на шаблон. | \-\> Prediction_Template |
|  | user_id | INT (FK) | Пользователь, сделавший ставку. | \-\> App_User |
|  | selection | VARCHAR | Выбранный вариант (1/X/2, over/under и т.д.). | \- |
|  | status | ENUM | 'PENDING', 'WON', 'LOST', 'VOID', 'CANCELLED', 'EXPIRED'. | \- |
|  | score_awarded | INT | Начисленные очки после расчёта. | \- |
|  | resolution_meta | JSON | Диагностическое описание для аудита. | \- |

| **Серия Прогнозов (Prediction_Streak)** | user_id | INT (PK, FK) | Пользователь. | \-\> App_User |
|  | current_streak | INT | Текущая серия правильных прогнозов. | \- |
|  | max_streak | INT | Максимальный рекорд. | \- |
|  | last_prediction_at | DATETIME | Время последнего прогноза. | \- |
|  | last_resolved_at | DATETIME | Время последнего расчёта. | \- |

| **Рейтинг Пользователя (User_Rating)** | user_id | INT (PK, FK) | Пользователь. | \-\> App_User |
|  | total_points | INT | Общий счёт за всё время. | \- |
|  | seasonal_points | INT | Очки текущего квартального рейтинга. | \- |
|  | yearly_points | INT | Очки годового рейтинга. | \- |
|  | current_level | ENUM | Уровень (BRONZE → MYTHIC). | \- |
|  | mythic_rank | INT | Позиция в мифическом тире (при попадании в TOP). | \- |

| **Снимок Рейтинга (Rating_Snapshot)** | rating_snapshot_id | BIGINT (PK) | Исторический снимок рейтинга. | \- |
|  | user_id | INT (FK) | Пользователь. | \-\> App_User |
|  | scope | ENUM | 'CURRENT' (квартал) / 'YEARLY'. | \- |
|  | rank | INT | Позиция в рейтинге. | \- |
|  | points | INT | Очки на момент снимка. | \- |
|  | captured_at | DATETIME | Время формирования снимка. | \- |

| **Админ-правки Очков (Admin_Point_Adjustment)** | point_adjustment_id | BIGINT (PK) | Операция корректировки очков. | \- |
|  | user_id | INT (FK) | Пользователь. | \-\> App_User |
|  | admin_identifier | VARCHAR | Идентификатор администратора. | \- |
|  | delta | INT | Добавленные/вычтенные очки. | \- |
|  | scope | ENUM | Какой рейтинг скорректирован. | \- |
|  | reason | TEXT | Обоснование для аудита. | \- |

| **Админ-лог (Admin_Action_Log)** | admin_action_log_id | BIGINT (PK) | Запись журнала. | \- |
|  | user_id | INT (FK, NULL) | Затронутый пользователь (если применимо). | \-\> App_User |
|  | action_type | VARCHAR | Тип операции (adjust_points, override_template и т.д.). | \- |
|  | target_type / target_id | VARCHAR | Сущность, над которой выполнено действие. | \- |
|  | metadata | JSON | Подробности для восстановления. | \- |
|  | expires_at | DATETIME | Время, после которого откат невозможен (72 часа). | \- |

| **Прогноз (Prediction)** | prediction_id | BIGINT (PK) | *Наследие первой версии*. Сохраняется для миграций и аналитики. | \- |
|  | user_id | INT (FK) | Пользователь, сделавший прогноз. | \-\> App_User |
|  | match_id | BIGINT (FK) | Матч. | \-\> Match |
|  | prediction_date | DATETIME | Дата и время прогноза. | \- |
|  | result_1x2 / total_goals_over / penalty_yes / red_card_yes |  | Поля старой модели (1X2, тотал, события). | \- |
|  | is_correct | BOOLEAN | Флаг корректности (legacy). | \- |
|  | points_awarded | INT | Очки за legacy-прогноз. | \- |

### **7\. Достижения (Achievements)**

| Таблица | Поле | Тип данных | Описание | Отношения |
| :---- | :---- | :---- | :---- | :---- |
| **Тип\_Достижения (Achievement\_Type)** | achievement\\\_type\\\_id | INT (PK) | ID типа достижения. | \- |
|  | name | VARCHAR(255) | Название (напр., "7 дней в приложении"). | \- |
|  | description | TEXT | Подробное описание. | \- |
|  | required\\\_value | INT | Требуемое значение (напр., 7 дней, 50 ставок). | \- |
|  | metric | ENUM | Метрика ('DAILY\_LOGIN', 'TOTAL\_PREDICTIONS', 'CORRECT\_PREDICTIONS'). | \- |
| **Достижение\_Пользователя (User\_Achievement)** | user\\\_id | INT (PK, FK) | Пользователь, получивший достижение. | \-\> App\_User |
|  | achievement\\\_type\\\_id | INT (PK, FK) | Ссылка на тип достижения. | \-\> Achievement\_Type |
|  | achieved\\\_date | DATETIME | Дата получения. | \- |

### **8\. Дисквалификации (Disqualifications)**

| Таблица | Поле | Тип данных | Описание | Отношения |
| :---- | :---- | :---- | :---- | :---- |
| **Дисквалификация (Disqualification)** | disqualification\_id | BIGINT (PK) | Уникальный ID дисквалификации. | \- |
|  | person\_id | INT (FK) | Игрок, получивший бан. | \-\> Персона |
|  | reason | ENUM | Причина ('RED\_CARD', 'ACCUMULATED\_CARDS', 'OTHER'). | \- |
|  | sanction\\\_date | DATETIME | Дата начала действия санкции. | \- |
|  | ban\\\_duration\\\_matches | INT | **Количество матчей, которое должен пропустить.** | \- |
|  | matches\\\_missed | INT | Количество уже пропущенных матчей. (Обновляется после каждого матча). | \- |
|  | is\\\_active | BOOLEAN | Флаг: TRUE, если бан еще действует (matches\_missed \< ban\_duration\_matches). | \- |

### **Четкая инструкция по применению (Обновлено)**

#### **Фаза 1: Настройка и планирование (Перед началом сезона)**

| Шаг | Действие | Используемые таблицы | Цель |
| :---- | :---- | :---- | :---- |
| **1\.** | **Регистрация основных объектов.** | Club, Person, Stadium, Tournament | Создать уникальные ID для всех клубов, игроков, судей и лиг. |
| **2\.** | **Открытие нового розыгрыша.** | Season | Создать новую запись, привязав ее к определенному Tournament (например, "Высшая Лига 2025"). |
| **3\.** | **Формирование участников.** | Season\_Participant | Для каждой лиги (Сезона) добавить все клубы-участники. |
| **4\.** | **Заявка команд.** | Season\_Roster | Для каждого клуба (club\_id) и сезона (season\_id) внести список игроков (person\_id) с их игровыми номерами (shirt\_number). |
| **5\.** | **Создание расписания.** | Match, **Match\\\_Series** | **Для плей-офф:** Сначала создать **Match\\\_Series** для каждого противостояния (1/8, 1/4). Затем создать 1, 2 или 3 Match, привязав их к соответствующему series\\\_id и указав series\\\_match\\\_number. **Для лиг:** Создать Match с series\\\_id \= NULL. |
| **6\.** | **Настройка достижений.** | Achievement\_Type | Внести все типы достижений с их метриками и требуемыми значениями (напр., metric='TOTAL\_PREDICTIONS', required\_value=50). |

#### **Фаза 2: Ход матча и фиксация данных (Match Recording)**

| Шаг | Действие | Используемые таблицы | Примечание |
| :---- | :---- | :---- | :---- |
| **1\.** | **Старт матча.** | Match | Обновить status с 'SCHEDULED' на **'LIVE'**. |
| **2\.** | **Формирование состава.** | Match\_Lineup | **Важный шаг:** Перед формированием состава **проверить Disqualification.is\_active**. Если активна, игрока нельзя включать в состав. |
| **3\.** | **Запись событий в реальном времени.** | Match\_Event | При каждом голе, карточке, или замене вносится новая запись с указанием match\_id, minute, event\_type и player\_id. |
| **4\.** | **Обновление счета.** | Match | По ходу матча обновлять home\_score и away\_score на основе записей в Match\_Event. |
| **5\.** | **Конец матча и определение победителя серии.** | Match, **Match\\\_Series** | Обновить status на **'FINISHED'**. Если матч принадлежит **Серии**, система должна **проверить общее количество побед в серии** и, при необходимости, обновить **Match\\\_Series.series\\\_status** на 'FINISHED' и заполнить **Match\\\_Series.winner\\\_club\\\_id**. |

#### **Фаза 3: Агрегация, Отчетность и История (Aggregation & Reporting)**

| Шаг | Действие | Используемые таблицы | Цель |
| :---- | :---- | :---- | :---- |
| **1\. Агрегация (После завершения матча):** | **Обновление сезонной статистики.** | Club\_Season\_Stats, Player\_Season\_Stats | Сразу после перехода Match.status в 'FINISHED' автоматически **обновить** или **добавить** к существующим суммам (голы, очки, победы) данные из только что сыгранного матча. **Это обеспечивает мгновенный доступ к таблицам и рейтингам.** |
| **2\. Обработка дисквалификаций (После завершения матча):** | **Обновление статуса бана.** | Disqualification | Для всех записей, где is\_active \= TRUE, **увеличить matches\_missed на 1**. Если matches\_missed стало равно ban\_duration\\\_matches, установить is\\\_active \= FALSE. |
| **3\. Назначение новых банов (После завершения матча):** | **Проверка на красные/накопленные.** | Match\_Event, Player\_Season\_Stats, Disqualification | **Красная карточка:** Если в Match\_Event есть 'RED\_CARD', создать новую запись в Disqualification с ban\\\_duration\\\_matches \= 1 и is\\\_active \= TRUE. **Накопление:** Проверить Player\\\_Season\\\_Stats на предмет достижения лимита желтых карточек. Если лимит достигнут, создать новую запись о бане. |
| **4\. Отчетность (Чтение данных):** | **Получение рейтингов/таблиц.** | Club\_Season\_Stats, Player\_Season\_Stats | **Никогда не считать\!** Приложение читает данные прямо из этих агрегированных таблиц, сортирует по очкам/голам и выводит Топ-10 или турнирную таблицу. |
| **5\. Исторический снапшот (После каждого матча):** | **Обновление карьерной статистики.** | Player\_Club\_Career\_Stats | После каждой финализации матча агрегировать Player\_Season\_Stats и Match\_Lineup, чтобы автоматически пересчитать карьерные показатели игрока в конкретном клубе (глубина: голы, передачи, матчи, ЖК/КК). |
| **6\. Пользовательская активность (При каждом входе):** | **Обновление серии и проверка достижений.** | App\_User, Achievement\_Type, User\_Achievement | При входе пользователя **обновить** поля **last\\\_login\\\_date** и **current\\\_streak** в таблице **App\\\_User** по логике, описанной выше. Затем проверить, не достигло ли новое значение current\\\_streak требуемого уровня в Achievement\\\_Type. |
| **7\. Прогнозы (До матча):** | **Запись прогноза и обновление счетчика.** | Prediction, App\_User | Записать прогноз пользователя (user\_id) на конкретный match\_id. **Увеличить total\\\_predictions на 1** в таблице **App\\\_User**. |
| **8\. Проверка прогнозов (После матча):** | **Обновление is\_correct и проверка достижений.** | Prediction, User\_Achievement | После перехода Match.status в 'FINISHED' пройтись по всем прогнозам на этот матч, проверить их корректность, обновить поле is\\\_correct и начислить points\\\_awarded. **Проверить прогресс по достижениям (например, "20 выигрышных ставок")** на основе обновленных данных в Prediction. |

## **Управление Административной Панелью (Admin Dashboard Management)**

Админ-панель должна обеспечивать CRUD-операции над ключевыми таблицами, при этом автоматически запуская логику, чтобы обеспечить целостность данных и немедленное отражение изменений в приложении.

### **1\. Управление Справочниками (Базовый CRUD)**

Эти таблицы содержат основные объекты. CRUD здесь стандартный, но с обязательной проверкой связей.

| Таблица | Управление (CRUD) | Особенности и Зависимости |
| :---- | :---- | :---- |
| **Клуб (Club)** | Создание, Редактирование, Удаление | **Удаление:** Запрещено, если клуб является участником активного сезона (Season\_Participant) или если на него ссылается завершенный Match. Требуется архивирование или мягкое удаление. |
| **Персона (Person)** | Создание, Редактирование, Удаление | **Редактирование:** Флаг is\_player (игрок/не игрок) важен для заявок и составов. **Удаление:** Запрещено, если персона была в Season\_Roster или Match\_Lineup. |
| **Турнир (Competition)** | Создание, Редактирование, Удаление | **Новое:** Добавлено поле **series\\\_format**, которое должно быть выбрано при создании турнира. **Удаление:** Запрещено, если на него ссылается активный Season. |
| **Стадион (Stadium)** | Создание, Редактирование, Удаление | **Удаление:** Запрещено, если на него ссылаются запланированные или завершенные Match. |
| **Тип\_Достижения (Achievement\_Type)** | Создание, Редактирование, Удаление | **Редактирование:** При изменении required\\\_value или metric необходимо **пересчитать** (запустить проверку) достижения для всех пользователей. |

### **2\. Управление Сезонами и Составами (Конфигурация)**

Здесь админ готовит сезон к запуску.

| Таблица | Управление (CRUD) | Особенности и Зависимости |
| :---- | :---- | :---- |
| **Сезон (Season)** | Создание, Редактирование | **Создание:** Требуется привязка к существующему Competition. **Редактирование:** Даты (start\\\_date, end\\\_date) не должны меняться после создания расписания, если матчи уже сыграны. |
| **Участник\_Сезона (Season\_Participant)** | Создание, Удаление | **Создание:** Добавление клуба в сезон. **Удаление:** Запрещено, если клуб уже сыграл матчи в этом сезоне. |
| **Заявка\_Сезона (Season\_Roster)** | Создание, Удактирование (Номера), Удаление | **Создание/Редактирование:** Удобный интерфейс: выбор **Клуба** и **Сезона**, затем добавление только тех Person, у кого is\\\_player \= TRUE. **Валидация:** Проверка на дублирование номеров (shirt\\\_number) в пределах одного клуба/сезона. |

### **3\. Управление Матчами и Событиями (Самое важное)**

Это самый критичный раздел. Изменения здесь должны запускать автоматическую переагрегацию.

| Таблица | Управление (CRUD) | Особенности и Зависимости |
| :---- | :---- | :---- |
| **Серия\_Матчей (Match\_Series)** | **Создание, Просмотр, Редактирование (Ограниченное), Удаление** | **Создание:** Необходим для всех плей-офф пар. **Редактирование:** Поля series\\\_status и winner\\\_club\\\_id должны обновляться **автоматически** после завершения последнего матча в серии. Ручное редактирование разрешено только в случае ошибок. |
| **Матч (Match)** | Создание, Редактирование, Удаление | **Создание:** **Для лиг:** series\\\_id и series\\\_match\\\_number остаются **NULL**. **Для плей-офф:** Нужно выбрать существующий **series\\\_id** и указать **series\\\_match\\\_number** (1, 2...). **Редактирование счета/статуса:** При сохранении счета и установке **status \= 'FINISHED'** автоматически запускается **триггер агрегации**, который, в случае серии, также **проверяет и закрывает Match\\\_Series**. |
| **Событие\_Матча (Match\_Event)** | Создание, Редактирование, Удаление | **Редактирование:** События (голы, карточки) могут редактироваться только в статусе матча 'LIVE' или 'FINISHED'. При редактировании **гола** или **карточки** в завершенном матче должен быть запущен **триггер пересчета** статистики и дисквалификаций. |
| **Дисквалификация (Disqualification)** | Создание, Редактирование (Ручной бан), Удаление | **Создание:** Автоматически после красной карточки/накопления. **Ручное создание:** Возможность назначить бан игроку по причине 'OTHER', задав ban\\\_duration\\\_matches. **Удаление/Редактирование:** Позволяет администратору досрочно снять бан, установив is\\\_active \= FALSE или обнулив ban\\\_duration\\\_matches. |
| **Состав\_Матча (Match\_Lineup)** | Редактирование | Доступно для коррекции: позволяет админу поменять роль игрока ('STARTER' / 'SUBSTITUTE') или позицию. Изменения в составе **не требуют пересчета статистики**. |

### **4\. Управление Пользователями и Прогнозами (Поддержка)**

Эти данные генерируются приложением и пользователями. Админ-панель должна использоваться в основном для просмотра и **ручной коррекции ошибок**.

| Таблица | Управление (CRUD) | Особенности и Зависимости |
| :---- | :---- | :---- |
| **Пользователь\_Приложения (App\_User)** | Просмотр, Редактирование (Ограниченное) | **Редактирование:** Только для полей, требующих ручной коррекции после ошибки: first\\\_name, **current\\\_streak**, **total\\\_predictions**. Редактирование telegram\\\_id запрещено. |
| **Прогноз (Prediction)** | Просмотр, Редактирование (Ограниченное) | **Редактирование:** Доступно только для is\\\_correct и points\\\_awarded в случае, если автоматический пересчет дал сбой или была исправлена ошибка в матче. При ручном изменении is\\\_correct нужно **обновить общий рейтинг пользователя**. |
| **Достижение\_Пользователя (User\_Achievement)** | Просмотр, Удаление | **Удаление:** Позволяет админу отозвать достижение, если оно было выдано ошибочно. **Не создавать вручную** — достижения должны выдаваться только автоматически. |
| **Статистика Агрегированная** (Все таблицы \*\\\_Stats) | Просмотр | **Редактирование запрещено\!** Эти таблицы являются результатом автоматических расчетов. Если данные неверны, админ должен исправить источник (Матч, Событие, Дисквалификация) и запустить переагрегацию. |

