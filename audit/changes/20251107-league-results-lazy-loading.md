# Вкладка «Результаты» — ленивые туры и разгрузка API

**Дата:** 7 ноября 2025 г.  
**Тип изменения:** Оптимизация производительности + UI

## Проблемы

- `/api/league/results` возвращал все матчи сезона, что приводило к большим payload (до 2–3 МБ) и нагружало Redis/БД при каждом открытии вкладки.
- UI рисовал длинный список матчей; повторные визиты не использовали ETag по турам.
- `appStore` не умел подгружать отдельные туры и не мог показывать состояние загрузки/ошибки внутри карточки тура.

## Решение

1. **Backend**
   - В `backend/src/services/leagueSchedule.ts` добавлен расчёт индекса туров (метаданные, ключи, версии) и отдельный загрузчик `buildLeagueResultsForRound`.
   - В `backend/src/routes/leagueRoutes.ts` теперь доступны два эндпоинта: `/api/league/results` (индекс) и `/api/league/results/round` (матчи тура). Оба работают с ETag и 304.
   - Обновлён `clubMatches` сервис, чтобы переиспользовать новую сборку результатов.

2. **Shared**
   - Расширены типы: `LeagueRoundMatches` содержит `roundKey`, `matchesCount`, `firstMatchAt`, `lastMatchAt`.

3. **Frontend**
   - В `frontend/src/store/appStore.ts` реализованы новые состояния `resultsRound*`, ленивый `fetchLeagueResults({ roundKey })`, обновлены merge-хелперы и localStorage-persistence.
   - `LeaguePage` и `LeagueRoundsView` показывают аккордеоны туров, загружают матчи по требованию, отображают скелетон/ошибку/кнопку «Повторить».
   - Добавлены стили `leagueRounds.css`, чтобы аккордеон выглядел в стиле неокубизма.

4. **Документация**
   - Обновлены `docs/state.md`, `docs/cache.md`, `docs/TTL.md`, `docs/style.md`, `docs/project.md`, `docs/roadmap.md` под новую архитектуру.

## Проверки

- `npm run lint` (frontend) — обнаружены существующие ошибки в `predictionsApi.ts`, `ratingsApi.ts`, `TeamView.tsx`, `PredictionsPage.tsx`; они присутствовали до изменений и требуют отдельного фикс-пакета.
- Ручной прогон UI: проверены сценарии раскрытия туров, повторная загрузка при ошибке, кэширование уже загруженных матчей.

## Риски и последующие шаги

- Требуется прогнать линтер после чистки старых файлов (`TeamView`, `PredictionsPage`).
- Желательно покрыть ленивые запросы туров интеграционными тестами и добавить k6-скрипт для оценки реального выигрыша по сети/Redis.
- Следующий шаг — адаптивный polling по турам (избегать частых refetch при быстрых раскрытиях).
