# Кубковая система с группами и Gold/Silver плей-офф

**Дата:** 2025-11-28  
**Версия:** 1.0.0

## Описание

Реализована полноценная кубковая система турниров с групповым этапом и плей-офф сеткой Gold/Silver.

### Эталонная конфигурация: 4 группы × 3 команды (12 команд)

```
Групповой этап:
┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐
│Группа A │  │Группа B │  │Группа C │  │Группа D │
│ 1. ─────┼─→│ 1. ─────┼─→│ 1. ─────┼─→│ 1. ─────│
│ 2. ─────│  │ 2. ─────│  │ 2. ─────│  │ 2. ─────│
│ 3. ─────│  │ 3. ─────│  │ 3. ─────│  │ 3. ─────│
└────┼────┘  └────┼────┘  └────┼────┘  └────┼────┘
     └───────────→└───────────→└───────────→│

Квалификация (2-е vs 3-и места):
A2 vs B3  →  победитель vs A1 (1/4 финала)
B2 vs A3  →  победитель vs B1 (1/4 финала)
C2 vs D3  →  победитель vs C1 (1/4 финала)
D2 vs C3  →  победитель vs D1 (1/4 финала)

1/4 финала:
  Победители → Золотой полуфинал
  Проигравшие → Серебряный полуфинал

Золотой кубок:
  Полуфинал 1: QF1 winner vs QF2 winner
  Полуфинал 2: QF3 winner vs QF4 winner
  Матч за 3 место: SF losers
  Финал: SF winners

Серебряный кубок:
  Полуфинал 1: QF1 loser vs QF2 loser
  Полуфинал 2: QF3 loser vs QF4 loser
  Матч за 3 место: SF losers
  Финал: SF winners
```

## Изменения в схеме базы данных

### Новый enum: `BracketType`
```prisma
enum BracketType {
  QUALIFICATION
  GOLD
  SILVER
}
```

### Новые поля в `Season`
```prisma
model Season {
  groupRounds    Int @default(1)    // 1 или 2 круга в группе
  playoffBestOf  Int @default(1)    // до скольких побед в серии плей-офф
}
```

### Новое поле в `MatchSeries`
```prisma
model MatchSeries {
  bracketType BracketType?  // тип сетки для кубков
}
```

## Новые файлы

### `backend/src/services/cupBracketLogic.ts`
Полная логика кубковой системы:
- `validateCupConfiguration()` — валидация конфигурации групп
- `generateQualificationPairs4x3()` — генерация пар квалификации
- `generateQuarterFinalPairs4x3()` — генерация пар 1/4 финала
- `createGoldSemiFinalPlans()` / `createSilverSemiFinalPlans()` — полуфиналы
- `createGoldFinalPlans()` / `createSilverFinalPlans()` — финалы и матчи за 3 место
- `getCupStageRank()` — порядок сортировки стадий
- Константы названий стадий: `CUP_STAGE_NAMES`

### `prisma/migrations/20251128120000_cup_bracket_settings/migration.sql`
Миграция для добавления новых полей и enum.

## Изменения в существующих файлах

### `backend/src/services/seasonAutomation.ts`
- Добавлены параметры `groupRounds` и `playoffBestOf` в `SeasonAutomationInput`
- Параметры сохраняются в сезон при создании
- Передача `groupRounds` в `createGroupStageSchedule()`

### `backend/src/services/matchAggregation.ts`
- Добавлена проверка `isCupFormat` в `maybeCreateNextPlayoffStage()`
- Добавлена функция `maybeCreateCupNextStage()` для прогрессии кубка
- Добавлена функция `createCupSeriesWithMatches()` для создания серий кубка
- Импортированы функции из `cupBracketLogic.ts`

### `backend/src/routes/adminRoutes.ts`
- Добавлены параметры `groupRounds` и `playoffBestOf` в `/seasons/auto` endpoint
- Валидация: `groupRounds` ∈ {1, 2}, `playoffBestOf` ∈ {1, 3, 5, 7}

### `backend/src/routes/bracketRoutes.ts`
- Добавлена поддержка `bracketType` в ответ API
- Группировка стадий по `bracketType` (отдельно Gold/Silver)
- Добавлен `GROUP_SINGLE_ROUND_PLAYOFF` в поиск сезонов с bracket
- Новые поля в ответе: `bracketType`, `bracketSlot`, `isCupFormat`, `groupRounds`, `playoffBestOf`

## API изменения

### POST `/admin/seasons/auto`
Новые параметры в теле запроса:
```json
{
  "groupRounds": 1,      // опционально, по умолчанию 1
  "playoffBestOf": 1     // опционально, по умолчанию 1
}
```

### GET `/api/bracket`
Новые поля в ответе:
```json
{
  "season": {
    "groupRounds": 1,
    "playoffBestOf": 1,
    "isCupFormat": true
  },
  "stages": [
    {
      "stageName": "1/4 финала",
      "bracketType": null,
      "series": [
        {
          "bracketType": null,
          "bracketSlot": 1
        }
      ]
    },
    {
      "stageName": "Полуфинал (Gold)",
      "bracketType": "GOLD",
      "series": [...]
    }
  ]
}
```

## Поддерживаемые конфигурации

| Группы | Размер | Всего команд | В плей-офф | Выбывают | Статус |
|--------|--------|--------------|------------|----------|--------|
| 4 | 3 | 12 | 12 (через квалификацию) | 0 | ✅ Эталон |
| 2 | 4 | 8 | 8 | 0 | ✅ Готово |
| 2 | 5 | 10 | 8 | 2 (5-е места) | ✅ Готово |
| 3 | 3 | 9 | 8 | 1 (худшее 3-е место) | ✅ Готово |
| 3 | 4 | 12 | 8 | 4 (4-е места) | ✅ Готово |

### Конфигурация 3×3 (9 команд → 8 в плей-офф)

```
Групповой этап:
┌─────────┐  ┌─────────┐  ┌─────────┐
│Группа A │  │Группа B │  │Группа C │
│ 1. ─────┼→ │ 1. ─────┼→ │ 1. ─────│ Seed 1-3
│ 2. ─────┼→ │ 2. ─────┼→ │ 2. ─────│ Seed 4-6
│ 3. ─────│  │ 3. ─────│  │ 3. ─────│ Seed 7-8 (2 лучших)
└─────────┘  └─────────┘  └─────────┘    ↓ выбывает 1

Определение 8 лучших:
1. Все 1-е места (3 команды) → Seed 1-3
2. Все 2-е места (3 команды) → Seed 4-6
3. 2 лучших 3-х места → Seed 7-8
4. Худшее 3-е место выбывает

Сравнение при равенстве мест:
1. Очки
2. Личные встречи
3. Разница мячей
4. Голы забитые

1/4 финала:
QF1: Seed 1 vs Seed 8
QF2: Seed 2 vs Seed 7
QF3: Seed 3 vs Seed 6
QF4: Seed 4 vs Seed 5
```

### Конфигурация 3×4 (12 команд → 8 в плей-офф)

```
Групповой этап:
┌─────────┐  ┌─────────┐  ┌─────────┐
│Группа A │  │Группа B │  │Группа C │
│ 1. ─────┼→ │ 1. ─────┼→ │ 1. ─────│ Seed 1-3
│ 2. ─────┼→ │ 2. ─────┼→ │ 2. ─────│ Seed 4-6
│ 3. ─────│  │ 3. ─────│  │ 3. ─────│ Seed 7-8 (2 лучших)
│ 4. ─────│  │ 4. ─────│  │ 4. ─────│ выбывают
└─────────┘  └─────────┘  └─────────┘

4-е места всех групп выбывают (3 команды)
Из 3-х мест выбывает 1 худшее
```

### Конфигурация 2×4 (8 команд → все в плей-офф)

```
Групповой этап:
┌─────────┐  ┌─────────┐
│Группа A │  │Группа B │
│ 1. ─────┼→ │ 1. ─────│
│ 2. ─────┼→ │ 2. ─────│
│ 3. ─────┼→ │ 3. ─────│
│ 4. ─────┼→ │ 4. ─────│
└─────────┘  └─────────┘

Кросс-схема 1/4 финала:
QF1: A1 vs B4 (Seed 1 vs 8)
QF2: B1 vs A4 (Seed 2 vs 7)
QF3: A2 vs B3 (Seed 3 vs 6)
QF4: B2 vs A3 (Seed 4 vs 5)
```

### Конфигурация 2×5 (10 команд → 8 в плей-офф)

```
Групповой этап:
┌─────────┐  ┌─────────┐
│Группа A │  │Группа B │
│ 1. ─────┼→ │ 1. ─────│
│ 2. ─────┼→ │ 2. ─────│
│ 3. ─────┼→ │ 3. ─────│
│ 4. ─────┼→ │ 4. ─────│
│ 5. ─────│  │ 5. ─────│ выбывают
└─────────┘  └─────────┘

5-е места обеих групп выбывают
```

## Логика прогрессии

1. **Групповой этап завершён** → Автоматически создаётся квалификация
2. **Квалификация завершена** → Автоматически создаётся 1/4 финала
3. **1/4 финала завершён** → Создаются Gold и Silver полуфиналы
4. **Полуфиналы завершены** → Создаются финалы и матчи за 3 место

## Миграция

```bash
# Применить миграцию
npx prisma migrate deploy

# Или для разработки
npx prisma migrate dev --name cup_bracket_settings
```

## Тестирование

```bash
# Запуск тестов (если есть)
npm run test

# Проверка компиляции
npx tsc --noEmit -p backend/tsconfig.json
```

## Совместимость

- ✅ Существующая логика LEAGUE не изменена
- ✅ Обратная совместимость с существующими сезонами
- ✅ Поля имеют значения по умолчанию

---

## 🎨 План Frontend: Админка (`/admin`)

### Этап 1: Настройки создания сезона

**Файл:** `admin/src/components/SeasonsTab.tsx` (или аналогичный)

1. **Добавить выбор формата групп**
   ```tsx
   // Выпадающий список конфигураций
   <Select
     label="Конфигурация турнира"
     options={[
       { value: '4x3', label: '4 группы × 3 команды (12)' },
       { value: '3x3', label: '3 группы × 3 команды (9)' },
       { value: '3x4', label: '3 группы × 4 команды (12)' },
       { value: '2x4', label: '2 группы × 4 команды (8)' },
       { value: '2x5', label: '2 группы × 5 команд (10)' },
     ]}
   />
   ```

2. **Добавить настройки формата**
   ```tsx
   // Количество кругов в группе
   <RadioGroup
     label="Круги в группе"
     options={[
       { value: 1, label: '1 круг' },
       { value: 2, label: '2 круга' },
     ]}
   />
   
   // Формат плей-офф
   <RadioGroup
     label="Формат плей-офф"
     options={[
       { value: 1, label: '1 матч' },
       { value: 3, label: 'До 2 побед (bo3)' },
       { value: 5, label: 'До 3 побед (bo5)' },
     ]}
   />
   ```

3. **Визуальный конфигуратор групп**
   - Drag & Drop для распределения команд по группам
   - Автоматическое заполнение по посеву (рейтингу)
   - Валидация: каждая группа должна иметь одинаковое количество команд

### Этап 2: Просмотр сетки плей-офф

**Файл:** `admin/src/components/BracketView.tsx`

1. **Разделение Gold/Silver brackets**
   ```tsx
   <Tabs>
     <Tab label="Золотой кубок" value="gold" />
     <Tab label="Серебряный кубок" value="silver" />
   </Tabs>
   ```

2. **Визуализация сетки**
   - SVG или Canvas сетка с линиями между стадиями
   - Цветовая индикация: Gold = золотой, Silver = серебряный
   - Отображение победителей/проигравших каждой пары

3. **Информационная панель**
   - Текущая стадия турнира
   - Количество завершённых / оставшихся матчей
   - Даты следующих матчей

### Этап 3: Управление матчами

**Файл:** `admin/src/components/MatchesTab.tsx`

1. **Фильтр по типу сетки**
   ```tsx
   <Select
     label="Тип сетки"
     options={[
       { value: 'all', label: 'Все матчи' },
       { value: 'GROUP', label: 'Групповой этап' },
       { value: 'QUALIFICATION', label: 'Квалификация' },
       { value: 'GOLD', label: 'Золотой кубок' },
       { value: 'SILVER', label: 'Серебряный кубок' },
     ]}
   />
   ```

2. **Визуальные метки серий**
   - Badge с типом сетки (GOLD/SILVER/QUALIFICATION)
   - Счёт серии для bo3/bo5 форматов

---

## 📱 План Frontend: Основное приложение (`/frontend`)

### Этап 1: Страница турнира

**Файл:** `frontend/src/pages/Tournament.tsx` (новый)

1. **Вкладки турнира**
   ```tsx
   <Tabs>
     <Tab label="Группы" />
     <Tab label="Плей-офф" />
     <Tab label="Статистика" />
   </Tabs>
   ```

2. **Групповой этап**
   - Таблицы групп с позициями, очками, разницей мячей
   - Цветовая индикация: зелёный = проходит, красный = выбывает
   - Кликабельные команды → переход в профиль клуба

3. **Плей-офф сетка**
   - Компактная визуализация сетки
   - Разделение Gold/Silver (tabs или два блока)
   - Анимации при обновлении результатов

### Этап 2: Страница матча плей-офф

**Файл:** `frontend/src/pages/MatchDetail.tsx` (обновление)

1. **Информация о серии**
   ```tsx
   // Если матч часть серии bo3/bo5
   <SeriesInfo>
     <SeriesScore home={2} away={1} />
     <SeriesFormat>До 2 побед</SeriesFormat>
   </SeriesInfo>
   ```

2. **Контекст турнира**
   - Название стадии (1/4 финала, Полуфинал Gold и т.д.)
   - Badge типа сетки
   - Ссылка на полную сетку

### Этап 3: Главная страница

**Файл:** `frontend/src/pages/Home.tsx` (обновление)

1. **Виджет текущего турнира**
   ```tsx
   <CurrentTournamentWidget>
     <TournamentName>Кубок Осени 2025</TournamentName>
     <CurrentStage>1/4 финала</CurrentStage>
     <NextMatch match={...} />
   </CurrentTournamentWidget>
   ```

2. **Быстрый доступ к сетке**
   - Мини-превью сетки с текущими результатами
   - Клик → полная страница турнира

### Этап 4: Компоненты

**Новые компоненты:**

```
frontend/src/components/
├── tournament/
│   ├── GroupTable.tsx         # Таблица группы
│   ├── BracketSvg.tsx         # SVG визуализация сетки
│   ├── BracketMatch.tsx       # Одна пара в сетке
│   ├── SeriesScore.tsx        # Счёт серии bo3/bo5
│   ├── BracketTypeBadge.tsx   # Badge GOLD/SILVER
│   └── TournamentProgress.tsx # Прогресс турнира
```

---

## 🛠 Технические задачи Frontend

### Общие

1. **Типы** (`shared/types.ts`)
   ```ts
   export type BracketType = 'QUALIFICATION' | 'GOLD' | 'SILVER'
   
   export interface CupStage {
     stageName: string
     bracketType: BracketType | null
     series: CupSeries[]
   }
   
   export interface CupSeries {
     id: number
     bracketType: BracketType | null
     bracketSlot: number
     homeClub: ClubInfo
     awayClub: ClubInfo
     summary: { homeLabel: string; awayLabel: string }
   }
   ```

2. **API клиент**
   - Обновить `bracketClient.ts` для новых полей ответа
   - Добавить кэширование сетки (SWR)

3. **Стили**
   - CSS переменные для Gold/Silver цветов
   - Адаптивная сетка для мобильных

### Приоритеты

| Приоритет | Задача | Оценка |
|-----------|--------|--------|
| 🔴 High | Настройки создания сезона в админке | 4-6 часов |
| 🔴 High | Просмотр сетки в админке | 4-6 часов |
| 🟡 Medium | Страница турнира в приложении | 6-8 часов |
| 🟡 Medium | Обновление страницы матча | 2-3 часа |
| 🟢 Low | Виджет на главной | 2-3 часа |
| 🟢 Low | Анимации и полировка | 3-4 часа |

**Общая оценка:** 21-30 часов разработки
